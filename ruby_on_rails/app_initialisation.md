# Initialise the Rails App

## Default Rails setup

* Install the latest Ruby version with `asdf install ruby latest` (Check if it's supported by Heroku).

* Switch your global Ruby to the fresh one: `asdf global ruby latest`

* Run `gem update --system` to update Ruby's default gems (e.g. `bundler`).

* [Check if you are using the latest stable version of Rails](http://rubyonrails.org/) with `rails -v` and update it if you are not.
You can do this with `gem update rails`. Beware of beta versions.

* Start a new Rails project using `rails new [project-name] --database=postgresql --skip-test --skip-action-mailbox` where the `project-name` is exactly the one you chose before.

  * You can use the `--css` flag to preconfigure your new Rails app to use a CSS processor/framework. Available options are: `tailwind, bootstrap, bulma, postcss, sass`. This will automatically install the [cssbundling-rails](https://github.com/rails/cssbundling-rails) and [jsbundling-rails](https://github.com/rails/jsbundling-rails) gems. The app then uses the the [esbuild](https://github.com/evanw/esbuild) JS bundler and minifier by default.

  * Esbuild is generally a good choice, but you can also configure an alternative JS bundler using the `--javascript` flag. You have the choice between using one of the node-based bundlers: `esbuild, rollup, webpack` or you can use `importmap`, which is the default. Note that importmaps cannot be used in conjunction with the `--css` option from above.

  * You may want to choose a different database from Postgres, but most of the time that will be your choice.
If you do not need a DB you may rethink the fact that you may not need Rails at all :) Take a look at [Sinatra](http://www.sinatrarb.com/) or [Angular](https://angular.io/)

* Check if you've got a `.ruby-version` file and create one if not . If  there is already one in the project, be sure to remove the `ruby-` prefix from the version number inside the file, leaving only the number itself.

* Load the Ruby version automatically in the fresh project's `Gemfile` by adding this:

  ```rb
  ruby File.read(File.join(__dir__, '.ruby-version')).strip
  ```

  [This is used by Heroku to determine what version to use.](https://devcenter.heroku.com/articles/ruby-versions)

* Run `bin/setup`

* Run `bundle exec rails db:migrate` to generate an empty `schema.rb` file.

* Check your default Rails setup by running either `bin/dev` or `rails s`, depending on whether you are using a node-based bundler with the foreman Procfile-runner, or if you are using importmaps and then visit `localhost:3000`.
You should be on Rails now, yay!

## Adjustments

### Convenience scripts (`bin/*`)

The following scripts are standardized tools for more convenience at Renuo.
They are always idempotent (runnable multiple times).

* Add a `bin/fastcheck` file. It will be used as a hook before pushing to quickly check for linting issues.

  ```sh
  echo "#\!/bin/sh\n" >> bin/fastcheck
  ```

* Add a `bin/check` file. It will run all the automated tests. It's mainly used in our CI.

  ```sh
  echo "#\!/bin/sh\nset -e\nbin/fastcheck\nbin/rails zeitwerk:check" > bin/check
  ```

* Make the new scripts executable

  ```sh
  chmod +x bin/fastcheck bin/check
  ```

* `bin/setup` was generated by Rails. We'll add a `pre-push` hook to it:

  ```ruby
  unless File.exist?('.git/hooks/pre-push')
    system 'ln -s ../../bin/fastcheck .git/hooks/pre-push'
  end
  ```

  Also change `system!('bundle install')` to `system!('bundle install --jobs=3 --retry=3')`

#### If you are using a node-based JS bundler using `jsbundling-rails`

* Add the following to `bin/setup` to allow intalling all dependencies in one go

  ```ruby
  system! 'yarn install'
  ```

#### If you use `importmap-rails` and there is no `bin/dev` file yet

* Create one and make it executable. It will be used to start our project.

  ```sh
  echo "#\!/bin/sh\nset -e\n\nrails s" >> bin/dev && chmod +x bin/dev
  ```

### ENV variables with Figaro

* Add `figaro` to Gemfile. Check the [gem homepage](https://github.com/laserlemon/figaro) to see how to install the gem
(usually `bundle exec figaro install` is enough). Delete the newly created file `config/application.yml`.
* and create `config/application.example.yml` where you will specify the only environment variable you need for now:
  `SECRET_KEY_BASE`.
* Add the following section to your `bin/setup` script so that the application.yml is created when the project is setup:

  ```ruby
  puts "\n== Copying sample files =="
  unless File.exist?('config/application.yml')
    system! 'cp config/application.example.yml config/application.yml'
  end
  ```

* add application.yml to .gitignore
* add one first key to application.example.yml `APP_PORT: 3000`

  Make sure it comes **before** any `rails` comands.
* To ensure you have all the required keys from the `application.example.yml` in your `application.yml`,
create the initializer for figaro in `config/initializers/figaro.rb`:

  ```ruby
  Figaro.require_keys(YAML.load_file('config/application.example.yml').keys - %w[test production development])
  ```

* Run `bin/setup` again.

### Configuration customisation

* Update `config/application.rb` and set the default language and timezone

  ```ruby
  config.time_zone = 'Zurich' # may vary
  config.i18n.default_locale = :de # may vary
  ```

* Update your `config/environments/production.rb` settings:

  ```ruby
  config.force_ssl = true # uncomment
  config.log_level = ENV['RAILS_LOG_LEVEL']&.to_sym || :warn # change
  ```

* Update `config/environments/development.rb` settings:

  ```ruby
  config.action_controller.action_on_unpermitted_parameters = :raise
  config.action_view.raise_on_missing_translations = true # uncomment
  ```

* Update `config/environments/test.rb` settings:

  ```ruby
  config.action_controller.action_on_unpermitted_parameters = :raise
  config.action_view.raise_on_missing_translations = true # uncomment
  config.i18n.exception_handler = Proc.new { |exception| raise exception.to_exception } # add
  config.active_record.verbose_query_logs = true # add
  ```

* Enable the default [Content Security Policies](https://github.com/renuo/applications-setup-guide/blob/master/ruby_on_rails/content_security_policy.md) in `config/initializers/content_security_policy.rb`.
  The report URI will be set later in the step of Sentry configuration.

## Finalising

* Check if the following scripts run successfully: `bin/setup`, `bin/check`, `bin/dev`
* If they do, commit all your changes to the main branch with Git.
