# Initialise the Rails App

## Default Rails setup

* Check if you are using the latest version of ruby supported by SemahoreCI and Heroku with `ruby -v`
and update it if you are not. Run `rbenv versions` to check your installed ruby versions.
Follow the instructions on screen to eventually install it.

* Switch the global Ruby version to the newest one with `rbenv global <ruby-version>` so that the latter commands
run in the correct context.

* Run `gem install bundler` to install Bundler.
You may have it already installed, but this command will make sure that you have the latest version.

* [Check if you are using the latest stable version of Rails](http://rubyonrails.org/) with `rails -v` and update it if you are not.
You can do this with `gem update rails`. Beware of beta versions.

* Start a new Rails project using `rails new [project-name] --database=postgresql --skip-test --skip-sprockets --webpacker` where the `project-name` is exactly the one you chose before.
You may want to choose a different database from Postgres, but most of the time that will be your choice.
If you do not need a DB you may rethink the fact that you may not need Rails at all :) Take a look at [Sinatra](http://www.sinatrarb.com/) or [Angular](https://angular.io/)

* Update the Ruby version in `.ruby-version` and load it in the fresh project's `Gemfile` like this

  ```ruby File.read(File.join(__dir__, '.ruby-version'))```

  [This is used by Heroku to determine what version to use.](https://devcenter.heroku.com/articles/ruby-versions)

* Run `bin/setup`
* Then check your default Rails setup by running `rails s` and visiting `localhost:3000`.
  You should be on Rails now, yay!

## Adjustments

### Convenience scripts (`bin/*`)

* Add a `bin/run` file. It will be used to start our project.

  ```sh
  echo "#\!/bin/sh\n\nbundle exec puma" >> bin/run
  ```

* Add a `bin/fastcheck` file. It will be used as a hook before pushing to quickly check for linting issues.

  ```sh
  echo "#\!/bin/sh\n" >> bin/fastcheck
  ```

* Add a `bin/check` file. It will run all the automated tests. It's mainly used in our CI.

  ```sh
  echo "#\!/bin/sh\nset -e\nbin/fastcheck\n" > bin/check
  ```

* Make the new scripts executable

  ```sh
  chmod +x bin/run bin/fastcheck bin/check
  ```

* `bin/setup` was generated by Rails. We'll add a `pre-push` hook to it:

  ```ruby
  unless File.exist?('.git/hooks/pre-push')
    system 'ln -s ../../bin/fastcheck .git/hooks/pre-push'
  end
  ```

  Also change `system!('bundle install')` to `system!('bundle install --jobs=3 --retry=3')`
  and uncomment the installation of yarn dependencies with `system('bin/yarn')`

* Run `bundle exec rails db:migrate` to generate an empty `schema.rb` file
* Run `bin/setup`.

### ENV variables with Figaro

* Add `figaro` to Gemfile. Check the [gem homepage](https://github.com/laserlemon/figaro) to see how to install the gem
(usually `bundle exec figaro install` is enough)
* and create `config/application.example.yml` where you will specify the only environment variable you need for now:
  `SECRET_KEY_BASE`.
* Add the following section to your `bin/setup` script so that the application.yml is created when the project is setup:

```ruby
    puts "\n== Copying sample files =="
    unless File.exist?('config/application.yml')
      system! 'cp config/application.example.yml config/application.yml'
    end
```

* To ensure you have all the required keys from the `application.example.yml` in your `application.yml`,
create the initializer for figaro in `config/initializers/figaro.rb`:

```ruby
Figaro.require_keys(YAML.load_file('config/application.example.yml').keys - %w[test production development])
```

### Configuration customisation

* Update `config/application.rb` and set the default language and timezone

```ruby
config.time_zone = 'Bern' # may vary
config.i18n.default_locale = :de # may vary
```

* Update your `config/environments/production.rb` settings:

```ruby
config.force_ssl = true # uncomment
config.log_level = :warn # change
```

* Update `config/environments/test.rb` settings:

```ruby
config.action_view.raise_on_missing_translations = true # uncomment
```

* Enable the default Content Security Policies in `config/initializers/content_security_policy.rb`.

The report URI will be set later in the step of Sentry configuration.

* Commit all your changes in the master branch.
