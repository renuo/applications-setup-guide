# Initialise the Rails App

## Default Rails setup

* Install the latest Ruby version with `asdf install ruby latest` (Check if it's supported by Heroku).

* Switch your global Ruby to the fresh one: `asdf global ruby latest`

* Run `gem update --system` to update Ruby's default gems (e.g. `bundler`).

* [Check if you are using the latest stable version of Rails](http://rubyonrails.org/) with `rails -v` and update it if
  you are not.
  You can do this with `gem update rails`. Beware of beta versions.

* Before you set up the Rails application, you should decide with your team upon which JS approach you want to use for
  the project.
  The [official documentation](https://guides.rubyonrails.org/working_with_javascript_in_rails.html#choosing-between-import-maps-and-a-javascript-bundler)
  can help you make this decision.
    * In the case that you want to use a more traditional JS Bundler, add `--javascript=esbuild` to the generation
      command below. `ESBuild` is the preferred option here.
    * If you want to use importmaps instead, you can skip the `--javascript` flag since this is Rails 7 default.

* Start a new Rails project using `rails new [project-name] --database=postgresql --skip-test --skip-action-mailbox`
  where the `project-name` is exactly the one you chose before.

    * You can add the `--css=bootstrap` flag to preconfigure your new Rails app to use a CSS processor/framework.
      Note that this flag will not work with importmaps and in that case you should
      follow [this guide](https://dev.to/coorasse/rails-7-bootstrap-5-and-importmaps-without-nodejs-4g8) instead.

    * You may want to choose a database other than Postgres, but if so, this should be discussed and agreed upon with
      the team before setting up the app. For most use-cases, Postgresql should be the preferred choice.
      If you do not need a DB you may rethink the fact that you may not need Rails at all :) Take a look
      at [Sinatra](http://www.sinatrarb.com/) or [Angular](https://angular.io/)

* Check if you've got a `.ruby-version` file and create one if not. If there is already one in the project, be sure to
  remove the `ruby-` prefix from the version number inside the file, leaving only the version number itself.

* Load the Ruby version automatically in the fresh project's `Gemfile` by adding this:

  ```rb
  ruby File.read(File.join(__dir__, '.ruby-version')).strip
  ```

  [This is used by Heroku to determine what version to use.](https://devcenter.heroku.com/articles/ruby-versions)

* Run `bin/setup`

* Run `bundle exec rails db:migrate` to generate an empty `schema.rb` file.

* Then check your default Rails setup by running rails s and visiting localhost:3000. You should be on Rails now, yay!

## Adjustments

### Convenience scripts (`bin/*`)

The following scripts are standardized tools for more convenience at Renuo.
They are always idempotent (runnable multiple times).

* Add a `bin/fastcheck` file. It will be used as a hook before pushing to quickly check for linting issues.

  ```sh
  echo "#\!/bin/sh\n" > bin/fastcheck && chmod +x bin/fastcheck
  ```

* Add a `bin/check` file. It will run all the automated tests. It's mainly used in our CI.

  ```sh
  echo "#\!/bin/sh\nset -e\nbin/fastcheck\nbin/rails zeitwerk:check" > bin/check && chmod +x bin/check
  ```

* `bin/setup` was generated by Rails. We'll add a `pre-push` hook to it:

  ```ruby
  unless File.exist?('.git/hooks/pre-push')
    system 'ln -s ../../bin/fastcheck .git/hooks/pre-push'
  end
  ```

  Also change `system!('bundle install')` to `system!('bundle install --jobs=3 --retry=3')`

#### If you are using a node-based JS bundler using `jsbundling-rails`

* Add a `bin/run` file. It will be used to start our project.

  ```sh
  echo "#\!/bin/sh\nset -e\n\nbin/dev" > bin/run && chmod +x bin/run
  ```

* Add the following to `bin/setup` to install all dependencies in one go.

  ```ruby
  system! 'yarn install --check-files'
  ```

#### Or if you are using `importmap-rails` instead

* Add a `bin/run` file. It will be used to start our project.

  ```sh
  echo "#\!/bin/sh\nset -e\n\nrails s" > bin/run && chmod +x bin/run
  ```

### ENV variables with Figaro

* Add `figaro` to Gemfile. Check the [gem homepage](https://github.com/laserlemon/figaro) to see how to install the gem
  (usually `bundle exec figaro install` is enough). Delete the newly created file `config/application.yml`.
* and create `config/application.example.yml` where you will specify the only environment variable you need for now:
  `SECRET_KEY_BASE`.
* Add the following section to your `bin/setup` script so that the application.yml is created when the project is setup:

  ```ruby
  puts "\n== Copying sample files =="
  unless File.exist?('config/application.yml')
    system! 'cp config/application.example.yml config/application.yml'
  end
  ```

* add application.yml to .gitignore
* add one first key to application.example.yml `APP_PORT: 3000`

  Make sure it comes **before** any `rails` comands.
* To ensure you have all the required keys from the `application.example.yml` in your `application.yml`,
  create the initializer for figaro in `config/initializers/figaro.rb`:

  ```ruby
  Figaro.require_keys(YAML.load_file('config/application.example.yml').keys - %w[test production development])
  ```

* Run `bin/setup` again.

### Configuration customisation

* Update `config/application.rb` and set the default language and timezone

  ```ruby
  config.time_zone = 'Zurich' # may vary
  config.i18n.default_locale = :de # may vary
  ```

* Update your `config/environments/production.rb` settings:

  ```ruby
  config.force_ssl = true # uncomment
  config.log_level = ENV['RAILS_LOG_LEVEL']&.to_sym || :warn # change
  ```

* Update `config/environments/development.rb` settings:

  ```ruby
  config.action_controller.action_on_unpermitted_parameters = :raise
  config.i18n.raise_on_missing_translations = true # uncomment
  ```

* Update `config/environments/test.rb` settings:

  ```ruby
  config.action_controller.action_on_unpermitted_parameters = :raise
  config.i18n.raise_on_missing_translations = true # uncomment
  config.i18n.exception_handler = Proc.new { |exception| raise exception.to_exception } # add
  config.active_record.verbose_query_logs = true # add
  ```

* Enable the
  default [Content Security Policies](https://github.com/renuo/applications-setup-guide/blob/master/ruby_on_rails/content_security_policy.md)
  in `config/initializers/content_security_policy.rb`.
  The report URI will be set later in the step of Sentry configuration.

* If you're using `jsbundling-rails`, let's clean up after asset precompilation
  to reduce Heroku slug size. Add this to the `Rakefile`:

  ```ruby
  Rake::Task['assets:clean'].enhance do
    FileUtils.remove_dir('node_modules', true)
    FileUtils.remove_dir('vendor/javascript', true)
  end
  ```

## Finalising

* Check if the following scripts run successfully: `bin/setup`, `bin/check`, `bin/run`
* If they do, commit all your changes to the main branch with Git.
