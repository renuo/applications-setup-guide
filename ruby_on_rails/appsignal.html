<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Lograge - Renuo - Application Setup Guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Renuo - Application Setup Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="logging--appsignal"><a class="header" href="#logging--appsignal">Logging &amp; AppSignal</a></h1>
<p>AppSignal is a service to record logs, monitor errors and performance.
Recording logs works independently from the tech stack. So you should use AppSignal
to record logs even if you don't use Rails. In Heroku we'll add a log drain to
redirect the multiplexed Logplex logs to AppSignal in any case.</p>
<h2 id="with-the-appsignal-agent"><a class="header" href="#with-the-appsignal-agent">With the AppSignal agent</a></h2>
<p>If you want to log errors and metrics, you need to install the AppSignal agent
into your app. See integration instructions for <a href="https://docs.appsignal.com/logging/platforms/integrations/ruby.html">Ruby/Rails</a>.</p>
<ul>
<li>
<p>Add the following gem to your Gemfile:</p>
<pre><code class="language-ruby">gem 'appsignal'
</code></pre>
</li>
<li>
<p>Add a AppSignal configuration file <a href="../templates/config/appsignal.yml"><code>config/appsignal.yml</code></a> folder.</p>
</li>
<li>
<p>Add the new variables to your Heroku environments:</p>
<pre><code class="language-yml">APPSIGNAL_APP_ENV: "main | develop"
APPSIGNAL_APP_NAME: "project name without env"
APPSIGNAL_IGNORE_ERRORS: "ActiveRecord::RecordNotFound,ActionController::UnknownFormat"
APPSIGNAL_PUSH_API_KEY: "from appsignal"
</code></pre>
</li>
</ul>
<p>We use the same push key for all apps. You can either copy it from another project or "create" an app on appsignal.
This will just show you the key and tell you to deploy the app with it for the app to be created.</p>
<p>Once you deploy the app and collect data the app will show up in the appsignal dashboard.
Navigate to <strong>Logging</strong> -&gt; <strong>Manage Resources</strong> and <strong>Add log resource</strong> with these settings:</p>
<div class="table-wrapper"><table><thead><tr><th>Setting</th><th>Value</th></tr></thead><tbody>
<tr><td>Source name</td><td><code>Rails</code></td></tr>
<tr><td>Platform</td><td><code>Heroku Log Drain</code></td></tr>
<tr><td>Message format</td><td><code>logfmt</code></td></tr>
</tbody></table>
</div>
<p>Then add this ingestion endpoint as a log drain using the Heroku commands displayed.</p>
<h2 id="only-logs"><a class="header" href="#only-logs">Only Logs</a></h2>
<p>Choose the "JavaScript" option on the AppSignal project page to
setup your project without an active agent.</p>
<h2 id="configuration-adjustments"><a class="header" href="#configuration-adjustments">Configuration adjustments</a></h2>
<h3 id="correct-severity"><a class="header" href="#correct-severity">Correct Severity</a></h3>
<p>According to <a href="https://docs.appsignal.com/logging/platforms/heroku.html">the docs</a>, getting the severity to be anything but "INFO" is not possible using the heroku drain.</p>
<p>However, there is now a way to send the <code>"severity=XYZ"</code> logfmt information and have that be applied correctly in appsignal. Unfortunately, just setting this seems to break the recognition of <code>request_id</code> in the format <code>[1234-5678]</code>. So we have to override the <code>ActiveSupport::TaggedLogging::Formatter</code> to add both the <code>severity</code> and the <code>request_id</code> in logfmt syntax.</p>
<pre><code class="language-ruby"># frozen_string_literal: true

if Rails.env.production?
  module ActiveSupport
    module TaggedLogging
      module Formatter
        def call(severity, timestamp, progname, msg)
          logfmt_msg = ["severity=#{severity}", tags_text, msg].compact.join(' ')
          super(severity, timestamp, progname, logfmt_msg)
        end

        def tags_text
          current_tags.map do |tag|
            if tag.is_a? Hash
              tag.map { |k, v| "#{k}=#{v}" }
            else
              "[#{tag}]"
            end
          end.flatten.join(' ')
        end
      end
    end
  end
end
</code></pre>
<p>and</p>
<pre><code class="language-ruby"># config/environments/production.rb
Rails.application.configure do
  # We use our custom key value tagging
  config.log_tags = [-&gt;(request) { { request_id: request.request_id } }]
  logger           = ActiveSupport::Logger.new(STDOUT)
  config.logger    = ActiveSupport::TaggedLogging.new(logger)
end
</code></pre>
<h3 id="lograge"><a class="header" href="#lograge">Lograge</a></h3>
<p>We use <a href="https://github.com/roidrage/lograge">lograge</a> in many projects. Here is how to configure
it with AppSignal to get properly tagged logs.</p>
<p>Using this configuration we get the fully tagged lograge lines and also
the full stack trace with each line tagged with the request id. This allows
us to filter by request id with one click and get all relevant log data at once.</p>
<h3 id="with-appsignal-gem"><a class="header" href="#with-appsignal-gem">With AppSignal gem</a></h3>
<pre><code class="language-ruby"># config/initializers/lograge.rb
if ENV['LOGRAGE_ENABLED'] == 'true'
  Rails.application.configure do
    config.lograge.enabled = true
    config.lograge.keep_original_rails_log = true
    config.lograge.logger = Appsignal::Logger.new(
      "rails",
      format: Appsignal::Logger::LOGFMT
    )
    config.lograge.custom_payload do |controller|
      {
        request_id: controller.request.request_id
      }
    end
  end
end
</code></pre>
<h3 id="without-appsignal-gem"><a class="header" href="#without-appsignal-gem">Without AppSignal gem</a></h3>
<pre><code class="language-ruby"># config/environments/production.rb
Rails.application.configure do
  …

  if ENV['RAILS_LOG_TO_STDOUT'].present?
    config.log_tags = [-&gt;(request) { { request_id: request.request_id } }]
    logger          = ActiveSupport::Logger.new($stdout)
    config.logger   = ActiveSupport::TaggedLogging.new(logger)
  end
end
</code></pre>
<pre><code class="language-ruby"># config/initializers/lograge.rb
Rails.application.configure do
  …

  if ENV['LOGRAGE_ENABLED'] == 'true'
    config.lograge.enabled = true
    config.lograge.keep_original_rails_log = true
  end
end
</code></pre>
<h2 id="automation"><a class="header" href="#automation">Automation</a></h2>
<p>Unfortunately Appsignal doesn't provide an API for project configuration.
So if you need to do something on a lot of projects, you have to do it manually.</p>
<p>Project creation can be automated though with the following script.
Run it in a tmp folder. <strong>It writes into a file on disk.</strong></p>
<pre><code class="language-rb">#!/usr/bin/env ruby
require 'optparse'
require 'appsignal'
require 'appsignal/demo'

PUSH_API_KEY = "XXX"

options = {}
OptionParser.new do |opt|
  opt.on('--env APPSIGNAL_ENV') { |o| options[:env] = o }
  opt.on('--name APPSIGNAL_NAME') { |o| options[:name] = o }
end.parse!

raise OptionParser::MissingArgument if options[:env].nil? || options[:name].nil?

File.write 'config/appsignal.yml', &lt;&lt;~YAML
  #{options[:env]}:
    active: true
    push_api_key: #{PUSH_API_KEY}
    name: "#{options[:name]}"
YAML

Appsignal.config = Appsignal::Config.new(Dir.pwd, options[:env])
Appsignal::Demo.transmit
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../ruby_on_rails/bullet.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../ruby_on_rails/hotjar.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../ruby_on_rails/bullet.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../ruby_on_rails/hotjar.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
