<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Lograge - Renuo - Application Setup Guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Renuo - Application Setup Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="logs--error-monitoring-with-appsignal"><a class="header" href="#logs--error-monitoring-with-appsignal">Logs &amp; error monitoring with AppSignal</a></h1>
<p>AppSignal is a service to record logs, monitor errors and performance.
Recording logs works independently from the tech stack. So you should use AppSignal
to record logs even if you don't use Rails. In Heroku we'll add a log drain to
redirect the multiplexed Logplex logs to AppSignal in any case.</p>
<ol>
<li><a href="#backend">Backend</a></li>
<li><a href="#frontend">Frontend</a></li>
<li><a href="#verify-the-installation">Verify the installation</a></li>
</ol>
<h2 id="backend"><a class="header" href="#backend">Backend</a></h2>
<h3 id="logs--errors"><a class="header" href="#logs--errors">Logs &amp; errors</a></h3>
<p>If you want to log errors and metrics, you need to install the AppSignal agent
into your app. See integration instructions for <a href="https://docs.appsignal.com/logging/platforms/integrations/ruby.html">Ruby/Rails</a>.</p>
<ul>
<li>
<p>Add the following gem to your Gemfile:</p>
<pre><code class="language-ruby">gem 'appsignal', github: 'renuo/appsignal-ruby'
</code></pre>
</li>
<li>
<p>Add a AppSignal configuration file <a href="../templates/config/initializers/appsignal.rb"><code>config/initializers/appsignal.rb</code></a></p>
</li>
<li>
<p>Add the new variables to your Heroku environments:</p>
<pre><code class="language-yml">APPSIGNAL_APP_ENV: "main | develop"
APPSIGNAL_APP_NAME: "project name without env"
APPSIGNAL_IGNORE_ERRORS: "ActiveRecord::RecordNotFound,ActionController::UnknownFormat"
APPSIGNAL_PUSH_API_KEY: "from appsignal"
# APPSIGNAL_SAMPLING_RATE: "1.0'
</code></pre>
</li>
</ul>
<p>We use the same push key for all apps. You can either copy it from another project or "create" an app on appsignal.
This will just show you the key and tell you to deploy the app with it for the app to be created.</p>
<p>Once you deploy the app and collect data the app will show up in the appsignal dashboard.
Navigate to <strong>Logging</strong> -&gt; <strong>Manage Resources</strong> and <strong>Add log resource</strong> with these settings:</p>
<div class="table-wrapper"><table><thead><tr><th>Setting</th><th>Value</th></tr></thead><tbody>
<tr><td>Source name</td><td><code>Rails</code></td></tr>
<tr><td>Platform</td><td><code>Heroku Log Drain</code></td></tr>
<tr><td>Message format</td><td><code>logfmt</code></td></tr>
</tbody></table>
</div>
<p>Then add this ingestion endpoint as a log drain using the Heroku commands displayed.</p>
<h3 id="only-logs"><a class="header" href="#only-logs">Only Logs</a></h3>
<p>Choose the "JavaScript" option on the AppSignal project page to
setup your project without an active agent.</p>
<h3 id="configuration-adjustments"><a class="header" href="#configuration-adjustments">Configuration adjustments</a></h3>
<h4 id="correct-severity"><a class="header" href="#correct-severity">Correct Severity</a></h4>
<p>According to <a href="https://docs.appsignal.com/logging/platforms/heroku.html">the docs</a>, getting the severity to be anything but "INFO" is not possible using the heroku drain.</p>
<p>However, there is now a way to send the <code>"severity=XYZ"</code> logfmt information and have that be applied correctly in appsignal. Unfortunately, just setting this seems to break the recognition of <code>request_id</code> in the format <code>[1234-5678]</code>. So we have to override the <code>ActiveSupport::TaggedLogging::Formatter</code> to add both the <code>severity</code> and the <code>request_id</code> in logfmt syntax.</p>
<pre><code class="language-ruby"># frozen_string_literal: true

if Rails.env.production?
  module ActiveSupport
    module TaggedLogging
      module Formatter
        def call(severity, timestamp, progname, msg)
          logfmt_msg = ["severity=#{severity}", tags_text, msg].compact.join(' ')
          super(severity, timestamp, progname, logfmt_msg)
        end

        def tags_text
          current_tags.map do |tag|
            if tag.is_a? Hash
              tag.map { |k, v| "#{k}=#{v}" }
            else
              "[#{tag}]"
            end
          end.flatten.join(' ')
        end
      end
    end
  end
end
</code></pre>
<p>and</p>
<pre><code class="language-ruby"># config/environments/production.rb
Rails.application.configure do
  # We use our custom key value tagging
  config.log_tags = [-&gt;(request) { { request_id: request.request_id } }]
  logger           = ActiveSupport::Logger.new(STDOUT)
  config.logger    = ActiveSupport::TaggedLogging.new(logger)
end
</code></pre>
<h3 id="lograge"><a class="header" href="#lograge">Lograge</a></h3>
<p>We use <a href="https://github.com/roidrage/lograge">lograge</a> in many projects. Here is how to configure
it with AppSignal to get properly tagged logs.</p>
<p>Using this configuration we get the fully tagged lograge lines and also
the full stack trace with each line tagged with the request id. This allows
us to filter by request id with one click and get all relevant log data at once.</p>
<p><em>With AppSignal gem</em></p>
<pre><code class="language-ruby"># config/initializers/lograge.rb
if ENV['LOGRAGE_ENABLED'] == 'true'
  Rails.application.configure do
    config.lograge.enabled = true
    config.lograge.keep_original_rails_log = true
    config.lograge.logger = Appsignal::Logger.new(
      "rails",
      format: Appsignal::Logger::LOGFMT
    )
    config.lograge.custom_payload do |controller|
      {
        request_id: controller.request.request_id
      }
    end
  end
end
</code></pre>
<p><em>Without AppSignal gem</em></p>
<pre><code class="language-ruby"># config/environments/production.rb
Rails.application.configure do
  …

  if ENV['RAILS_LOG_TO_STDOUT'].present?
    config.log_tags = [-&gt;(request) { { request_id: request.request_id } }]
    logger          = ActiveSupport::Logger.new($stdout)
    config.logger   = ActiveSupport::TaggedLogging.new(logger)
  end
end
</code></pre>
<pre><code class="language-ruby"># config/initializers/lograge.rb
Rails.application.configure do
  …

  if ENV['LOGRAGE_ENABLED'] == 'true'
    config.lograge.enabled = true
    config.lograge.keep_original_rails_log = true
  end
end
</code></pre>
<h3 id="automation"><a class="header" href="#automation">Automation</a></h3>
<p>Unfortunately Appsignal doesn't provide an API for project configuration.
So if you need to do something on a lot of projects, you have to do it manually.</p>
<p>Project creation can be automated though with the following script.
Run it in a tmp folder. <strong>It writes into a file on disk.</strong></p>
<pre><code class="language-rb">#!/usr/bin/env ruby
require 'optparse'
require 'appsignal'
require 'appsignal/demo'

PUSH_API_KEY = "XXX"

options = {}
OptionParser.new do |opt|
  opt.on('--env APPSIGNAL_ENV') { |o| options[:env] = o }
  opt.on('--name APPSIGNAL_NAME') { |o| options[:name] = o }
end.parse!

raise OptionParser::MissingArgument if options[:env].nil? || options[:name].nil?

File.write 'config/initializers/appsignal.rb', &lt;&lt;~RUBY
  if defined?(Appsignal)
    Appsignal.configure do |config|
      %w[HTTP_REFERER HTTP_USER_AGENT HTTP_AUTHORIZATION REQUEST_URI].each do |header|
        config.request_headers &lt;&lt; header
      end
    end
  end
RUBY

Appsignal.config = Appsignal::Config.new(Dir.pwd, options[:env])
Appsignal::Demo.transmit
</code></pre>
<h2 id="frontend"><a class="header" href="#frontend">Frontend</a></h2>
<p>While the backend uses a secret <code>PUSH_API_KEY</code> to authenticate with AppSignal, the frontend uses a public <code>FRONTEND_API_KEY</code>
to authenticate with AppSignal. This key can only be read once the project is created on AppSignal.
So once the project is created, the frontend API key can be found in the "Push and deploy" section of your project settings.</p>
<p>Checkout the <a href="https://docs.appsignal.com/front-end/installation.html">AppSignal documentation</a> if you need more information.</p>
<p><em>Installation steps:</em></p>
<ul>
<li>Add the new frontend API key to your Heroku environments:
<pre><code class="language-yml">APPSIGNAL_FRONTEND_API_KEY: "from appsignal"
</code></pre>
</li>
<li>Install the package: <code>yarn add @appsignal/javascript</code></li>
<li>Include <a href="../templates/app/views/shared/_appsignal.html.erb">_appsignal.html</a> in your header.</li>
</ul>
<pre><code class="language-erb">&lt;%= render 'shared/appsignal' %&gt;
</code></pre>
<ul>
<li>Include <a href="../templates/app/javascript/appsignal.js">appsignal.js</a> in your JS assets.</li>
</ul>
<h2 id="verify-the-installation"><a class="header" href="#verify-the-installation">Verify the installation</a></h2>
<h3 id="error-monitoring"><a class="header" href="#error-monitoring">Error monitoring</a></h3>
<h4 id="ruby"><a class="header" href="#ruby">Ruby</a></h4>
<p>For each environment of your app, connect to the <code>heroku run rails console --app [project-name]-[branch-name]</code> and raise an exception using Appsignal:</p>
<pre><code>begin
  1 / 0
rescue ZeroDivisionError =&gt; exception
  Appsignal.send_error(exception)
end
</code></pre>
<p>You should find the exception of the ZeroDivisionError on Appsignal after a minute or two.</p>
<h4 id="javascript"><a class="header" href="#javascript">Javascript</a></h4>
<p>Open the dev console in chrome, and run</p>
<pre><code class="language-js">try {
  throw new Error('test appsignal js');
} catch(e) {
  Appsignal.sendError(e)
}
</code></pre>
<p>On Appsignal you should find "Uncaught Error: test appsignal js".</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../ruby_on_rails/bullet.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../ruby_on_rails/hotjar.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../ruby_on_rails/bullet.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../ruby_on_rails/hotjar.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
