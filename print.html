<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Renuo - Application Setup Guide</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-7a4acf39.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-a495be96.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>‚Üê</kbd> or <kbd>‚Üí</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Renuo - Application Setup Guide</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="renuo-application-setup-guide"><a class="header" href="#renuo-application-setup-guide">Renuo Application Setup Guide</a></h1>
<p>This repo is the <a href="https://www.renuo.ch">Renuo</a> collection of best-practices to set-up apps.
We are a <a href="https://rubyonrails.org/foundation">Rails company</a>, so the most value probably
will be found in the parts concerning Rails. But anyways you‚Äôll also find a lot about the
inner workings of Renuo.</p>
<ul>
<li><a href="#ruby-on-rails---application-setup-guide">Ruby on Rails ‚Äì Application Setup Guide</a></li>
</ul>
<h2 id="some-notes-on-the-side"><a class="header" href="#some-notes-on-the-side">Some Notes on the Side</a></h2>
<p>If you are reading this document, it means that you have to setup a new application.
A new project started and it‚Äôs now time to set everything up so that <strong>everyone</strong>,
in your team, <strong>can start working on it</strong>.</p>
<p>This document will try to be as minimalist as possible and provide you with all the steps to set up the application as
fast as possible. There are things, in Renuo projects, which are mandatory, other that are suggested.
This guide is the result of more than ten years of experience, so this means three things: it‚Äôs very robust, very opinionated, and possibly very outdated.</p>
<p><strong>You are always welcome to challenge the guide and improve it with a Pull Request.</strong></p>
<p>The basic things that need to be ready before the team can start working on a project are:</p>
<ul>
<li>An existing <em>git</em> repository containing the project</li>
<li>Two branches: <em>main</em> and <em>develop</em></li>
<li>A README with essential information about the application</li>
<li>Convenience-scripts: <code>bin/setup</code>, <code>bin/check</code>, <code>bin/fastcheck</code>, <code>bin/run</code></li>
<li>One running, green test</li>
<li>Continuous integration (<em>CI</em>) ready, running and green for both branches</li>
<li>Continuous deployment (<em>CD</em>) ready and running for both branches</li>
<li>The application deployed for both branches</li>
</ul>
<p>As an appendix, you‚Äôll find a <a href="#checklist">checklist</a> you can use to follow the guide.</p>
<p><strong>‚ùó Do not blindly follow this guide, always think about what you are doing and why.
If you think something is wrong or simply outdated, improve this guide with a Pull Request.</strong></p>
<p>We want you to know exactly the reason behind each single step of this guide.</p>
<p>Thank you for your work and have fun! üéâ</p>
<h2 id="serving-the-documentation-locally"><a class="header" href="#serving-the-documentation-locally">Serving the Documentation Locally</a></h2>
<p>To view this documentation on your machine, run the following command:</p>
<pre><code class="language-sh">mbook serve
</code></pre>
<h2 id="license"><a class="header" href="#license">License</a></h2>
<p><a href="https://creativecommons.org/licenses/by/4.0/legalcode">Attribution 4.0 International (CC BY 4.0)</a></p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="create-a-git-repository"><a class="header" href="#create-a-git-repository">Create a Git Repository</a></h1>
<p>At Renuo we currently use <a href="https://github.com/">GitHub</a> as our git repository. You should already be part of the Renuo Organisation and have permissions to do so.
If that‚Äôs not the case, double check the Laptop Setup Guide or ask wg-operations.</p>
<p>To create a new GitHub project you can use the tool you prefer, but it should have the following characteristics:</p>
<ul>
<li>Should be under <code>renuo</code> organisation</li>
<li>Should have <code>[project-name]</code> as a name</li>
<li>Should be private (unless you are creating an OpenSource project)</li>
</ul>
<p>Use the command <code>hub create -p renuo/[project-name]</code> to create the repo and add it to the origin of the current folder.</p>
<h2 id="public-repos-need-a-license"><a class="header" href="#public-repos-need-a-license">Public repos need a license</a></h2>
<p>If your repository is public, ensure that it contains a license.
We usually use the <a href="https://choosealicense.com/licenses/mit/">MIT</a> license if possible or a <a href="https://creativecommons.org/licenses/">CreativeCommons</a> license for documentation-only repositories (such as the application setup guide üôÇ).
You can add a license directly on GitHub while initializing a repository by selecting a license template in the ‚ÄúAdd a license‚Äù dropdown.
However, if the repository is already initialized, you‚Äôre still able to add a license using a template:</p>
<ul>
<li>Click <code>Create new file</code></li>
<li>Use <code>LICENSE</code> for the filename</li>
<li>Then click on <code>Choose a license template</code> and select the MIT license</li>
<li>Fill in Renuo AG in the full name placeholder</li>
<li>Click submit and commit the file</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="gitflow"><a class="header" href="#gitflow">Gitflow</a></h1>
<p>At Renuo we follow <a href="http://nvie.com/posts/a-successful-git-branching-model/">gitflow convention</a> and we use it in every project.
Please check it out and read how it works if you don‚Äôt know it yet.
It‚Äôs very important that you know how gitflow works to work at Renuo.</p>
<p>Since we follow gitflow, we have two main branches connected, via CD, to two servers, we call ‚Äúmain‚Äù and ‚Äúdevelop‚Äù.</p>
<pre><code class="language-mermaid">graph LR
A[main] --&gt; CI1(CI) --&gt; CD1(CD)
CD1(CD) --&gt; S11(server)
CD1(CD) --&gt; S12(server)

    B[develop] --&gt; CI2(CI) --&gt; CD2(CD)
    CD2(CD) --&gt; S21(server)
    CD2(CD) --&gt; S22(server)

    B[develop] --&gt; C[feature/1337-ff] --&gt; CI3(CI)
</code></pre>
<pre><code class="language-mermaid">sequenceDiagram
    actor Developer
    participant G as GitHub
    participant CI
    participant S as Server

    rect rgb(191, 223, 255)

    Developer-&gt;&gt;G: git push origin develop or main
    G-&gt;&gt;CI: notify about code change
    CI-&gt;&gt;G: checkout code
    CI-&gt;&gt;CI: run tests
    CI-&gt;&gt;S: deploy
    end
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="go-live"><a class="header" href="#go-live">Go Live</a></h1>
<h2 id="dns-ssl--smtp"><a class="header" href="#dns-ssl--smtp">DNS, SSL &amp; SMTP</a></h2>
<ul>
<li>Check your DNS records, for example
<ul>
<li><code>CNAME</code> to Heroku (<a href="https://devcenter.heroku.com/articles/custom-domains">see their docs</a>)</li>
<li><code>TXT</code> records for <a href="https://support.sparkpost.com/docs/getting-started/setting-up-domains">SparkPost sending domains</a></li>
<li><code>CAA</code> records (<a href="https://developers.cloudflare.com/ssl/edge-certificates/caa-records/#create-caa-records">see Cloudflare</a>)</li>
</ul>
</li>
<li>If SparkPost has been set up with the renuoapp.ch domain and the project has its own domain now, set up SparkPost again with its own domain</li>
<li>Verify that SparkPost mails are working and the <a href="https://app.sparkpost.com/domains/list/sending">sending domain is validated</a>.</li>
<li>Verify that SSL is working correctly</li>
</ul>
<p>If the final domain isn‚Äôt already in use, you can configure it also already:
Add a CNAME DNS record pointing to the app (<code>[project-name]-main.renuoapp.ch</code>).</p>
<h3 id="url-rewriting-on-cloudflare"><a class="header" href="#url-rewriting-on-cloudflare">URL rewriting on Cloudflare</a></h3>
<p>For user comfort we redirect HTTP calls to <a href="https://example.com">https://example.com</a> to <a href="https://www.example.com">https://www.example.com</a>.
This is done via page rules in Cloudflare.</p>
<ol>
<li>Add a new page rule</li>
<li>Enter <code>example.com/*</code></li>
<li>Choose ‚ÄúForwarding URL‚Äù</li>
<li>Choose ‚Äú301 - Permanent Redirect‚Äù</li>
<li>Enter <code>https://www.example.com/$1</code></li>
<li>Click ‚ÄúSave and Deploy‚Äù</li>
</ol>
<h2 id="deploio-preferred-deployment-method"><a class="header" href="#deploio-preferred-deployment-method">Deploio (Preferred Deployment Method)</a></h2>
<p>We now recommend deploying applications using <a href="https://deplo.io">Deploio</a>, moving away from Heroku.</p>
<p>When preparing your app for production on Deploio, ensure the following:</p>
<ul>
<li>Verify the machine type of the PostgreSQL database in the PostgreSQL resource view.</li>
<li>Confirm the configured application size in the application configuration tab.</li>
<li>Ensure the application replica count is correctly set in the application configuration tab.</li>
</ul>
<p>For detailed instructions and best practices, including quick start guides for a variety of frameworks, please refer to the <a href="https://guides.deplo.io/user-guide/network-and-deployment.html#network-deployment">Deploio deployment documentation</a>.</p>
<h2 id="heroku"><a class="header" href="#heroku">Heroku</a></h2>
<ul>
<li>Check the size and amount of dynos on Heroku</li>
<li>Check the database size plan on Heroku and upgrade if it is foreseeable that 10‚Äô000 rows are exceeded in a short time</li>
<li>Check additional addons and according plans on Heroku</li>
</ul>
<h2 id="other"><a class="header" href="#other">Other</a></h2>
<ul>
<li>Reset admin credentials, seeds, ‚Ä¶ if necessary</li>
<li>Test the whole application by hand if everything is working as it should</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="naming-conventions"><a class="header" href="#naming-conventions">Naming Conventions</a></h1>
<p>Naming the project properly is very important and even more important is doing it from the beginning.
We carefully choose the names for our projects and we always stick to the following conventions so you are
asked to do the same.</p>
<h2 id="project-name"><a class="header" href="#project-name">Project Name</a></h2>
<ul>
<li>The project name <code>[project-name]</code> only uses <code>[a-z0-9]</code> and dash <code>-</code>. No underscore <code>_</code>.</li>
<li>A project name is easy to remember and easy to pronounce. In the best case it consists of one word.</li>
<li>The project name should be unique and not too long.</li>
<li>It should not contain any version information.</li>
</ul>
<h2 id="extended-use"><a class="header" href="#extended-use">Extended Use</a></h2>
<ul>
<li>Use <code>[project-name]</code> for project names and services which are branch-independent.</li>
<li>Use <code>[project-name]-[branch]</code> for deployed projects (<code>[branch]</code> means the gitflow branch and not RAILS_ENV).</li>
<li>Use <code>[project-name]-[purpose]-[branch]</code> for deployed projects (e.g. one11-web-main).</li>
<li>Use <code>[project-name]-local-[user]-[rails_env]</code> for local names which interact with online services (e.g. S3).</li>
</ul>
<p><strong>Note:</strong> Previously on Heroku, the convention was to use <code>[project-name]-[branch]-[purpose]</code> for deployed projects (e.g. kingschair-main-assets). This has been updated due to deplo.io.</p>
<h2 id="examples"><a class="header" href="#examples">Examples</a></h2>
<ul>
<li>food-calendar, food-calendar-develop, food-calendar-develop-assets</li>
<li>food-calendar-api, food-calendar-api-develop, food-calendar-api-develop-assets</li>
<li>bauer-shoes, bauer-cars, bauer-cars-static</li>
<li>vdrb-kas, vdrb-mv</li>
<li>red-shoes, blue-hats (two projects which are independent and have the same customer)</li>
</ul>
<h2 id="scope-of-application"><a class="header" href="#scope-of-application">Scope of Application</a></h2>
<p>The naming conventions should be applied everywhere. Some examples:</p>
<ul>
<li>Amazon S3 (usually [project-name]-[branch])</li>
<li>Github ([project-name])</li>
<li>Heroku ([project-name]-[branch])</li>
<li>Redmine ([project-name])</li>
<li>Semaphore CI (servers are named [project-name]-[branch])</li>
<li>Drive ([project-name])</li>
<li>New Relic ([project-name]-[branch])</li>
<li>Get Sentry</li>
<li>App name in Rails</li>
<li>Sparkpost Account</li>
<li>External services (e.g. datatrans)</li>
<li>Database names</li>
<li>Nginx / Apache</li>
<li>Config files</li>
<li>Directory names</li>
<li>Analytics, Webmaster tools, Adwords</li>
<li>Etc‚Ä¶</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="security"><a class="header" href="#security">Security</a></h1>
<h2 id="email-contact"><a class="header" href="#email-contact">Email contact</a></h2>
<p>Make it easy for others to let you know about security issues.
Please add a security email contact to the HTML footer or the about page of every app.
Either use <code>security@&lt;project-domain&gt;</code> or <code>security@renuo.ch</code>.
Incoming issues will be treated with high priority by <em>wg-operations</em>.</p>
<p>There is also a <code>.well-known/security.txt</code> file you can provide:</p>
<pre><code class="language-txt">Contact: mailto:security@renuo.ch
Expires: 2050-11-11T13:37:42.000Z
Preferred-Languages: de, en
</code></pre>
<p>In case your repo is public, it is recommended to add a <code>SECURITY.md</code> to your repository‚Äôs root, docs, or .github folder:</p>
<pre><code># Security Policy

## Reporting a Vulnerability

To report a security vulnerability, please email security@renuo.ch.
</code></pre>
<h2 id="cipher-suite-review"><a class="header" href="#cipher-suite-review">Cipher suite review</a></h2>
<p>Review your SSL/TLS configuration periodically: <a href="https://www.ssllabs.com/ssltest/">https://www.ssllabs.com/ssltest/</a></p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="checklist"><a class="header" href="#checklist">Checklist</a></h1>
<ul>
<li><input disabled="" type="checkbox"> Application name chosen</li>
<li><input disabled="" type="checkbox"> Rails Application created</li>
<li><input disabled="" type="checkbox"> Git Repository created and configured</li>
<li><input disabled="" type="checkbox"> CI configured</li>
<li><input disabled="" type="checkbox"> Server created</li>
<li><input disabled="" type="checkbox"> CD configured</li>
<li><input disabled="" type="checkbox"> App running</li>
<li><input disabled="" type="checkbox"> Linting tools installed</li>
<li><input disabled="" type="checkbox"> RSpec installed</li>
<li><input disabled="" type="checkbox"> Suggested gems included</li>
<li><input disabled="" type="checkbox"> Sentry, Appsignal and/or NewRelic configured depending on your choice.</li>
<li><input disabled="" type="checkbox"> Logs on Appsignal configured</li>
<li><input disabled="" type="checkbox"> Cloudflare configured</li>
<li><input disabled="" type="checkbox"> README written and complete</li>
<li><input disabled="" type="checkbox"> Uptime Monitor configured</li>
<li><input disabled="" type="checkbox"> robots.txt configured</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="ruby-on-rails---application-setup-guide"><a class="header" href="#ruby-on-rails---application-setup-guide">Ruby On Rails - Application Setup Guide</a></h1>
<p>This setup will cover a pure, monolithic Rails Applications.
This is the most frequent type of application we have at <a href="https://renuo.ch">Renuo</a> and is probably also the easiest to setup.
The application (and relative GitHub repo) will be named after the <code>[project-name]</code> you chose before.</p>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Have you chosen a <code>[project-name]</code> yet? If not, please do so now. Check our <a href="#naming-conventions">Naming Conventions</a></p>
</blockquote>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Have you decided if you need two environments (develop and main) or just one?
As a rule of thumb: for customers we always use two environments, for internal projects we usually only use one.
Why the difference? Because we can bare the risk of having a bug in an internal project, but we cannot do that for a customer.</p>
</blockquote>
<ol>
<li><a href="#initialise-the-rails-application">Initialise the Rails Application</a></li>
<li><a href="#push-to-git-repository">Push to Git Repository</a></li>
<li><a href="#initialise-gitflow">Initialise Gitflow</a></li>
<li><a href="#configure-the-github-repository">Configure Git Repository</a></li>
<li><a href="#setup-application-server-for-deploio">Create an Application Server for Deploio</a> or <a href="#setup-application-server-for-heroku">Create an Application Server for Heroku</a></li>
<li><a href="#configure-the-ci">Configure the CI / CD</a></li>
</ol>
<p>Once here, your app should be up and running on all environments.</p>
<p>It‚Äôs now time to introduce some more tools which will help you and the team to keep a high quality during the project development.</p>
<ol>
<li><a href="#setup-rspec">RSpec</a></li>
<li><a href="#linting-and-automatic-checks-">Linting and automatic checks</a></li>
<li><a href="#suggested-gems">Gems and libraries üíé</a></li>
<li><a href="#cloudflare">Cloudflare</a></li>
<li><a href="ruby_on_rails/compile_readme.html">README</a></li>
</ol>
<p>üéâ Finally you are ready to start working on you new project! üéâ</p>
<p>While everyone starts working there are some more things which you should setup.
Most are not optional, but the rest of the team can start working even if those are not in place yet.</p>
<ol>
<li><a href="#logs--error-monitoring-with-appsignal">AppSignal</a></li>
<li><a href="#sentry">Sentry</a> (optional)</li>
<li><a href="#newrelic">NewRelic</a> (optional)</li>
<li><a href="#robotstxt">robots.txt</a></li>
<li><a href="#configure-percy">Percy</a> (optional)</li>
<li><a href="#staging-environment-protection">Protect develop environment</a></li>
</ol>
<p>Some services should be configured accordingly to the packages bought by the customer.
Once the new application is created, please add the project to the
<a href="https://docs.google.com/spreadsheets/d/1FY4jqByO-aI5sDan0hD7ULu6a2-eLsmO6kgdCFlPmuY/edit#gid=0">monitoring list</a>
and discuss with the PO how the service should be configured.</p>
<ol>
<li><a href="#uptimerobot-monitoring">Uptimerobot</a></li>
<li>Depending on the monitoring list, also <a href="#sentry">Sentry notifications</a> need to be configured.</li>
<li><a href="#depfu">Depfu security monitoring</a></li>
<li>Depending on the monitoring list, also <a href="ruby_on_rails/papertrail.html">Papertrail alerts</a> need to be configured.</li>
</ol>
<p>Here you will find a series of chapters and guides on how to setup some of the gems we use most often and some other
useful services:</p>
<ol>
<li><a href="#run-javascript-tests-with-jest">Run Javascript tests with Jest</a></li>
<li><a href="pull_requests_template.html">Pull Requests Template</a></li>
<li><a href="#slack-and-notifications">Slack and Project Notifications</a></li>
<li><a href="#-send-emails">Send emails</a></li>
<li><a href="#sparkpost--mailtrap-1">Sparkpost &amp; Mailtrap</a></li>
<li><a href="#devise">Devise</a></li>
<li><a href="#cucumber">Cucumber</a></li>
<li><a href="#object-storage">Object storage</a></li>
<li>awesome_print <code>gem 'awesome_print'</code></li>
<li><a href="#bootstrap">bootstrap</a></li>
<li><a href="#font-awesome">font-awesome</a></li>
<li><a href="#bullet">bullet</a> <code>gem 'bullet'</code></li>
<li><a href="#logs--error-monitoring-with-appsignal">lograge</a> <code>gem 'lograge'</code></li>
<li>Rack Tracker (Google Analytics) <code>gem 'rack-tracker'</code> ‚Äì&gt; see <a href="#google-analytics">Google Analytics</a></li>
<li>Favicons</li>
<li><a href="https://github.com/cyu/rack-cors">Rack CORS</a></li>
<li><a href="https://github.com/rack/rack-attack#installing">Rack Attack</a></li>
<li><a href="#-hotjar">üî• Hotjar</a></li>
<li>SEO
<ul>
<li>redirect non-www to www</li>
<li>Header tags</li>
</ul>
</li>
<li><a href="#wicked-pdf">wicked pdf</a> <code>gem wicked_pdf</code></li>
<li><a href="#recaptcha-v3">Recaptcha v3</a></li>
<li><a href="ruby_on_rails/wallee.html">Wallee Payment Integration</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="initialise-the-rails-application"><a class="header" href="#initialise-the-rails-application">Initialise the Rails Application</a></h1>
<h2 id="default-rails-setup"><a class="header" href="#default-rails-setup">Default Rails setup</a></h2>
<ul>
<li>
<p>Ensure that your asdf plugins are up to date with <code>asdf plugin update --all</code>.</p>
</li>
<li>
<p>Install the latest Ruby version with <code>asdf install ruby latest</code> (Check if it‚Äôs <a href="https://devcenter.heroku.com/articles/ruby-support#ruby-versions">supported by Heroku</a>).</p>
</li>
<li>
<p>Switch your global Ruby to the fresh one: <code>asdf global ruby latest</code>.</p>
</li>
<li>
<p>Run <code>gem update --system</code> to update Ruby‚Äôs default gems (e.g. <code>bundler</code>).</p>
</li>
<li>
<p><a href="http://rubyonrails.org/">Check if you are using the latest stable version of Rails</a> with <code>rails -v</code> and update it if you are not.
You can do this with <code>gem update rails</code>. Beware of beta versions.</p>
</li>
<li>
<p>Start a new Rails project using</p>
</li>
</ul>
<pre><code>rails new [project-name] --database=postgresql --skip-kamal --skip-ci --skip-action-mailbox --template https://raw.githubusercontent.com/renuo/application-setup-guide/main/ruby_on_rails/template.rb
</code></pre>
<p>where the <code>project-name</code> is exactly the one you chose before.</p>
<blockquote>
<p>‚ö†Ô∏è You may want to choose a different database than Postgres, but most of the time this will be your choice.<br>If you do not need a DB you may rethink the fact that you may not need Rails at all: Take a look at <a href="http://www.sinatrarb.com/">Sinatra</a> or <a href="https://angular.io/">Angular</a><br>You might also need actionmailbox of course, so always double-check the parameters that you are using.</p>
</blockquote>
<blockquote>
<p>‚≠êÔ∏è This setup does not include either js-bundling nor css-bundling by default.<br>It will start with the simplest possible Rails setup and will use sprockets and importmaps.<br>If you need to do fancy stuff, discuss with your team the opportunity of including a js-bundling and css-bundling tool.<br>We want to go <a href="https://www.youtube.com/watch?v=iqXjGiQ_D-A">‚Äúno build‚Äù</a> whenever possible.</p>
</blockquote>
<ul>
<li>
<p>Run <code>bin/setup</code></p>
</li>
<li>
<p>Run <code>bundle exec rails db:migrate</code> to generate an empty <code>schema.rb</code> file.</p>
</li>
<li>
<p>Then check your default Rails setup by running <code>rails s</code> and visiting http://localhost:3000.
You should be on Rails now, yay!</p>
</li>
<li>
<p>Finally check if http://localhost:3000/up is green.</p>
</li>
</ul>
<h2 id="adjustments"><a class="header" href="#adjustments">Adjustments</a></h2>
<p>Some adjustments are made automatically by the template, but you should check them.
Some other adjustments must be performed manually.</p>
<h3 id="automatic-adjustments"><a class="header" href="#automatic-adjustments">Automatic adjustments</a></h3>
<blockquote>
<p>‚≠êThe Gemfile reads the required ruby version from the <code>.ruby-version</code> file.
<a href="https://devcenter.heroku.com/articles/ruby-versions">This is used by Heroku to determine what version to use.</a>
Deploio reads the ruby version from the Gemfile, with the .ruby-version file inlined into it. https://paketo.io/docs/howto/ruby/#override-the-detected-ruby-version</p>
</blockquote>
<blockquote>
<p>‚≠êÔ∏èrenuocop replaces the default rubocop-rails-omakase. We have our own set of rules at Renuo.
You can discuss them at https://github.com/renuo/renuocop and you can also contribute to them.</p>
</blockquote>
<blockquote>
<p>‚≠êÔ∏èa bin/check script is added to the project. This script will run all the tests of the project.
It is used in our CI and can be used locally to check if everything is fine. You can customize it to your needs.</p>
</blockquote>
<blockquote>
<p>‚≠êÔ∏èa bin/fastcheck script is added to the project.
This script will run all the linters of the project. It is used in our CI and can be customized to your needs.
It will be used as a hook before pushing to quickly check for linting issues.</p>
</blockquote>
<blockquote>
<p>‚≠êÔ∏èa bin/run script is added to the project. This script will start the application.</p>
</blockquote>
<blockquote>
<p>‚≠êÔ∏èbin/check, bin/fastcheck and bin/run are standardized tools for more convenience at Renuo.</p>
</blockquote>
<h3 id="manual-adjustments"><a class="header" href="#manual-adjustments">Manual adjustments</a></h3>
<p>Please perform these adjustments manually:</p>
<h4 id="env-variables"><a class="header" href="#env-variables">ENV variables</a></h4>
<ul>
<li>
<p>Add <code>dotenv-rails</code> to Gemfile. Check the <a href="https://github.com/bkeepers/dotenv">gem homepage</a> to see how to install the gem.</p>
</li>
<li>
<p>and create <code>.env.example</code> in the root folder of the project where you will specify the only environment variable you need for now:
<code>SECRET_KEY_BASE</code>.</p>
</li>
<li>
<p>Going forward we will only push the <code>.env.example</code> file to the repository in order to protect our env variables.</p>
</li>
<li>
<p>Add .env to .gitignore</p>
</li>
<li>
<p>Add the following section to your <code>bin/setup</code> script so that the <code>.env</code> is created from the <code>.env</code> when the project is setup locally:</p>
<pre><code class="language-ruby">puts "\n== Copying sample files =="
unless File.exist?('.env')
  system! 'cp .env.example .env'
end
</code></pre>
</li>
<li>
<p>add one more key to .env.example <code>APP_PORT=3000</code></p>
</li>
<li>
<p>To ensure you have all the required keys from the <code>.env.example</code> in your <code>.env</code>,
create the initializer for dotenv-rails in <code>config/initializers/dotenv_rails.rb</code>:</p>
</li>
</ul>
<pre><code class="language-ruby">Dotenv.require_keys(Dotenv.parse(".env.example").keys)
</code></pre>
<ul>
<li>Run <code>bin/setup</code> again.</li>
</ul>
<h3 id="secrets"><a class="header" href="#secrets">Secrets</a></h3>
<p>We store the secrets necessary to configure the project locally in a 1password Item.
Create a new Item for the project called <code>[project-name] project secrets</code> of type note.
Right click on the vault and select <code>Copy Private link</code>.</p>
<ul>
<li>Run the command <code>renuo fetch-secrets --init [the vault private link]</code> to create an empty secrets file.</li>
</ul>
<p>The Item contains the fields that represent the ENV variables. You can use Text or Password fields.
Check existing projects for an example of the usage.</p>
<h4 id="configuration-customisation"><a class="header" href="#configuration-customisation">Configuration customisation</a></h4>
<ul>
<li>
<p>Update <code>config/application.rb</code> and set the default language and timezone</p>
<pre><code class="language-ruby">config.time_zone = 'Zurich' # may vary
config.i18n.default_locale = :de # may vary
</code></pre>
</li>
<li>
<p>Update your <code>config/environments/production.rb</code> settings:</p>
<pre><code class="language-ruby">config.force_ssl = true # uncomment
config.log_level = ENV.fetch("RAILS_LOG_LEVEL", "warn") # change
</code></pre>
</li>
<li>
<p>Update <code>config/environments/development.rb</code> settings:</p>
<pre><code class="language-ruby">config.action_controller.action_on_unpermitted_parameters = :raise
config.i18n.raise_on_missing_translations = :strict

config.generators do |g|
  g.apply_rubocop_autocorrect_after_generate!
end
</code></pre>
</li>
<li>
<p>Update <code>config/environments/test.rb</code> settings:</p>
<pre><code class="language-ruby">config.action_controller.action_on_unpermitted_parameters = :raise
config.i18n.raise_on_missing_translations = :strict
config.i18n.exception_handler = Proc.new { |exception| raise exception.to_exception } # add
config.active_record.verbose_query_logs = true # add

# add the following lines to the end of the file
config.to_prepare do
  ActiveSupport.on_load(:active_record) do
    ActiveRecord::ConnectionAdapters::PostgreSQLAdapter.create_unlogged_tables = true
  end
end
</code></pre>
</li>
<li>
<p>The default <a href="ruby_on_rails/content_security_policy.html">Content Security Policies</a> should not always be activated, but rather only where there are platform secrets that need to be secured. This rule can be overwritten by a customer, if he opted into CSP when selecting his maintenance plans.</p>
</li>
<li>
<p>If you‚Äôre using a js-bundling tool, let‚Äôs clean up after asset precompilation
to reduce the size of your deployment. Although deplo.io doesn‚Äôt have Heroku slugs, it is still good to set up. Add this to the <code>Rakefile</code>:</p>
<pre><code class="language-ruby">Rake::Task['assets:clean'].enhance do
  FileUtils.remove_dir('node_modules', true)
  FileUtils.remove_dir('vendor/javascript', true)
end
</code></pre>
</li>
</ul>
<h2 id="finalising"><a class="header" href="#finalising">Finalising</a></h2>
<ul>
<li>Check if the following scripts run successfully: <code>bin/setup</code>, <code>bin/check</code>, <code>bin/run</code></li>
<li>If they do, commit all your changes to the main branch with Git.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="push-to-git-repository"><a class="header" href="#push-to-git-repository">Push to Git Repository</a></h1>
<p>It‚Äôs now time to push to the git repository and configure our CI and CD to deploy our application on Heroku.
To do that you first need to <a href="#create-a-git-repository">Create a Git Repository</a>.</p>
<p>After creating the repo you can connect your project to the remote git repo (if you didn‚Äôt use <code>hub create</code> command)</p>
<pre><code class="language-sh">git remote add origin git@github.com:renuo/[project-name].git
</code></pre>
<p>and push using:</p>
<pre><code class="language-sh">git add .
git commit -m "Initial commit"
git push -u origin main
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="initialise-gitflow"><a class="header" href="#initialise-gitflow">Initialise Gitflow</a></h1>
<p>You can initialise gitflow in you project with <code>git flow init -d</code></p>
<p>Then push also your new develop branch <code>git push --set-upstream origin develop</code> if you have one.</p>
<p>Once you have pushed all the branches, you can finish the <a href="#configure-the-github-repository">configuration of Git Repository</a></p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="configure-the-github-repository"><a class="header" href="#configure-the-github-repository">Configure the GitHub Repository</a></h1>
<p>These are the suggested configurations for our GitHub repositories.
Please stick to it unless you have special needs.</p>
<ul>
<li>
<p>General Settings</p>
<ul>
<li>Features: Remove <em>Wikis</em>, <em>Issues</em> and <em>Projects</em></li>
<li>Pull Requests
<ul>
<li>Disable <em>Allow merge commits</em> and <em>Allow rebase merging</em></li>
<li>Allow auto-merge</li>
<li>Automatically delete head branches</li>
<li>Always suggest updating pull request branches</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Manage access</p>
<ul>
<li>Add <em>staff</em> team as a collaborator with Admin access</li>
<li>Add <em>security</em> team as collaborator with Write access</li>
</ul>
</li>
<li>
<p>Branches</p>
<ul>
<li>Default branch: either <code>main</code> or <code>develop</code> depending on whether you want one or two environments.</li>
</ul>
</li>
<li>
<p>Rules/Rulesets</p>
<ul>
<li><code>develop</code>
<ul>
<li>Enforcement status: <code>Active</code></li>
<li>Branch targeting criteria: <code>develop</code></li>
<li>Bypass list: add <code>Repository Admin</code> Role with <em>allow for pull requests only</em> option</li>
<li>Restrict deletions</li>
<li>Require linear history</li>
<li>Require a pull request before merging</li>
<li>Require status checks to pass
<ul>
<li>Select <code>ci/semaphore/push</code></li>
</ul>
</li>
<li>Block force pushes</li>
</ul>
</li>
<li><code>main</code> (same as develop but‚Ä¶)
<ul>
<li>Branch targeting criteria: <code>main</code></li>
<li>‚ùå Require a pull request before merging</li>
<li>‚ùå Require status checks to pass</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Autolink references</p>
<ul>
<li>Add a new Autolink reference with:
<ul>
<li>Reference prefix: <code>TICKET-</code></li>
<li>Target URL: <code>https://redmine.renuo.ch/issues/&lt;num&gt;</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="team"><a class="header" href="#team">Team</a></h2>
<p>Each project has a team owning it. The team is named after the project: <code>[team-name] = [project-name]</code>.
Thanks to this we can:</p>
<ul>
<li>
<p>see who is responsible for a project;</p>
</li>
<li>
<p>assign issues to the right team;</p>
</li>
<li>
<p>assign pull requests to the right team.</p>
</li>
<li>
<p>Create a team with the name of the project and add all the developers working on it;</p>
</li>
<li>
<p>Give to each team member the role ‚Äúmaintainer‚Äù;</p>
</li>
<li>
<p>Add the team to the repository with the ‚Äúadministrator‚Äù role;</p>
</li>
<li>
<p>Add a CODEOWNERS file with the team name in it:</p>
</li>
</ul>
<pre><code class="language-markdown"># .github/CODEOWNERS

* @renuo/[team-name]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="setup-application-server-for-heroku"><a class="header" href="#setup-application-server-for-heroku">Setup Application Server for Heroku</a></h1>
<h2 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h2>
<p>Before setting up your application, ensure you have completed the following for Heroku.</p>
<h3 id="prerequisites-for-heroku"><a class="header" href="#prerequisites-for-heroku">Prerequisites for Heroku</a></h3>
<ul>
<li>You‚Äôve <a href="https://www.heroku.com/platform">read about what Heroku is</a>.</li>
<li>You have a Heroku account.</li>
<li>You have installed the <code>renuo-cli</code> gem.</li>
</ul>
<h2 id="setup-your-application"><a class="header" href="#setup-your-application">Setup Your Application</a></h2>
<h3 id="setup-heroku-application"><a class="header" href="#setup-heroku-application">Setup Heroku Application</a></h3>
<h4 id="remote-configuration"><a class="header" href="#remote-configuration">Remote Configuration</a></h4>
<p>Run the command to generate a script which will create and configure all Heroku apps. <code>[project-name]</code> string length is limited to 22 characters:</p>
<pre><code class="language-sh">renuo create-heroku-app [project-name]
</code></pre>
<p>Please review the script before running it and execute only the commands you need and understand.
In particular, you might need only one of the two environments if you decided to not use <code>develop</code>.</p>
<p><strong>If you don‚Äôt know what a command does: read the documentation and then execute it.</strong></p>
<p>If you think that the script is outdated, please open a Pull Request on the <a href="https://github.com/renuo/renuo-cli">renuo-cli</a> project.</p>
<h4 id="setup-rails-for-heroku"><a class="header" href="#setup-rails-for-heroku">Setup Rails for Heroku</a></h4>
<ol>
<li>Add a file called <code>Procfile</code> to your code root:</li>
</ol>
<pre><code class="language-sh">web: bundle exec puma -C config/puma.rb
</code></pre>
<p>This file is read by Heroku to start the web app and worker jobs.</p>
<ol start="2">
<li>Add a file called <code>.slugignore</code> to your code root:</li>
</ol>
<pre><code class="language-sh">/spec
/.semaphore
</code></pre>
<p>This file allows you to mark files and folders to be excluded from the Heroku</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="setup-application-server-for-deploio"><a class="header" href="#setup-application-server-for-deploio">Setup Application Server for Deploio</a></h1>
<h2 id="prerequisites-1"><a class="header" href="#prerequisites-1">Prerequisites</a></h2>
<p>Before setting up your application, ensure you have completed the following for Deploio.</p>
<h3 id="prerequisites-for-deploio"><a class="header" href="#prerequisites-for-deploio">Prerequisites for Deploio</a></h3>
<ul>
<li>You‚Äôve <a href="https://docs.nine.ch/docs/deplo-io/getting-started-with-deploio">read about what Deploio is</a>.</li>
<li>You have a Deploio account.</li>
<li>You have installed the <code>renuo-cli</code> gem.</li>
<li>You have installed the <code>nctl</code> command.</li>
<li>You have logged in using <code>nctl</code>.</li>
</ul>
<h2 id="setup-your-application-1"><a class="header" href="#setup-your-application-1">Setup Your Application</a></h2>
<h3 id="setup-deploio-application"><a class="header" href="#setup-deploio-application">Setup Deploio Application</a></h3>
<h4 id="remote-configuration-1"><a class="header" href="#remote-configuration-1">Remote Configuration</a></h4>
<p>Run <a href="https://github.com/renuo/renuo-cli/blob/main/lib/renuo/cli/commands/create_deploio_app.rb">the command to generate a script</a> which will create and configure all Deploio apps. <code>[project-name]</code> string length is limited to 63 characters:</p>
<pre><code class="language-sh">renuo create-deploio-app [project-name] [git-url]
</code></pre>
<p>e.g. <code>renuo create-deploio-app my-app git@github.com:renuo/my-app.git</code></p>
<p>Please review the script before running it and execute only the commands you need and understand.
In particular, you might need only one of the two environments if you decided to not use <code>develop</code>.</p>
<p><strong>If you don‚Äôt know what a command does: read the documentation and then execute it.</strong></p>
<p>If you think that the script is outdated, please open a Pull Request on the <a href="https://github.com/renuo/renuo-cli">renuo-cli</a> project.</p>
<p>For further configuration and best practices, please refer to the <a href="https://guides.deplo.io">Deploio documentation</a>. You can also view a Ruby on Rails specific guide <a href="https://guides.deplo.io/ruby/quick-start.html">here</a>.</p>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<p>That‚Äôs it! You have now configured your application with Deploio. No more configuration is needed.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="configure-the-ci"><a class="header" href="#configure-the-ci">Configure the CI</a></h1>
<p>At Renuo we <strong>always</strong> use a CI (Continuous Integration) system to test our applications. It‚Äôs essential to guarantee
that all the tests pass before building and releasing a new version through our CD system. Our projects use
<a href="https://semaphoreci.com/">SemaphoreCI</a>.</p>
<p>‚ÑπÔ∏è <em>Are you using <strong>Gitlab</strong>? Have a look at <a href="ruby_on_rails/gitlab_capybara_selenium.html">this example</a> instead (and elaborate).</em></p>
<p>Before configuring the CI, you should already have a Git Repository with the code, a <code>bin/check</code> command to execute,
and the main branches already pushed and ready to be tested.</p>
<ol>
<li>Proceed to <a href="https://renuo.semaphoreci.com/">https://renuo.semaphoreci.com/</a> and login through GitHub with renuobot@renuo.ch (<a href="https://start.1password.com/open/i?a=QZNJJCCDWVCGBGI73Z2L55KSGE&amp;v=crlutt26yprmp6thr573qxsxkq&amp;i=u7rirvnrf5fjxd25caiq7ib6vq&amp;h=renuo.1password.com">1Password</a>)</li>
<li>Follow these instructions to install semaphore CLI https://docs.semaphoreci.com/reference/sem-command-line-tool/</li>
<li>Create a project here: <a href="https://renuo.semaphoreci.com/new_project">https://renuo.semaphoreci.com/new_project</a></li>
<li>Go to the project‚Äôs artifact settings: <code>Settings</code> &gt; <code>Artifacts</code></li>
<li>Set the retention policy for project, workflow and job artifacts to <code>/**/*</code> and <code>2 weeks</code></li>
</ol>
<h2 id="rails-specific-configuration"><a class="header" href="#rails-specific-configuration">Rails specific configuration</a></h2>
<pre><code class="language-sh">renuo configure-semaphore
</code></pre>
<p>The command will copy the necessary templates to <code>.semaphore</code> folder using the renuo-cli. These files need to be maintained on the <a href="https://github.com/renuo/renuo-cli/tree/main">renuo-cli repository</a>.
Adapt the files and remove the <code>develop</code> related ones if you don‚Äôt use the <code>develop</code> branch.</p>
<ol>
<li>Add a file called <code>.nvmrc</code> to the project root, where you specify the latest node version</li>
<li>Commit the files to both branches, push and watch the CI run.</li>
</ol>
<p>When all builds are green, then you have properly configured your CI and CD.</p>
<p><img src="images/semaphore_ci.png" alt="semaphoreci_2"></p>
<p>You should now see a third block where your deployment runs to Heroku.
Make sure it is green and deploys correctly:</p>
<p><img src="images/semaphore_cd.png" alt="semaphoreci_2"></p>
<h2 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h2>
<p>You have now your application running on all the environments.
From now on, all the changes you will push on <em>develop</em> or <em>main</em>
branches in GitHub will be automatically deployed to the related server.</p>
<p>It‚Äôs time to create some first Pull Requests with some improvements.</p>
<p><strong>Don‚Äôt forget to go back to the GitHub settings and add the CI to the required checks!</strong></p>
<h2 id="a-note-about-contacting-the-semaphore-support"><a class="header" href="#a-note-about-contacting-the-semaphore-support">A note about contacting the Semaphore support</a></h2>
<p>The Semaphore Support team will use your primary Github email address for communication.
If this is not the <code>renuo.ch</code> address, you need to tell them (<code>support@semaphoreci.com</code>)
to change your contact email address manually.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="setup-rspec"><a class="header" href="#setup-rspec">Setup RSpec</a></h1>
<p>Even though Rails uses Minitest per default, RSpec is the <em>de-facto</em> standard at Renuo.</p>
<p>Add the following gems to your Gemfile:</p>
<pre><code class="language-ruby">group :development, :test do
  gem "factory_bot_rails"
  gem "rspec-rails"
  gem "parallel_tests"
end

group :test do
  gem "shoulda-matchers"
  gem "simplecov", require: false
  gem "super_diff"
end
</code></pre>
<p>You should know exactly why you are adding each one of them and why is necessary.</p>
<ul>
<li>Also add <code>/coverage/</code> to your <code>.gitignore</code> file.</li>
<li>Remove the <code>test</code> folder from your project (there will be one called <code>spec</code> later).</li>
</ul>
<h2 id="configuration"><a class="header" href="#configuration">Configuration</a></h2>
<ul>
<li>Install rspec via <code>rails generate rspec:install</code></li>
<li>Create a bin stub with <code>bundle binstubs rspec-core</code></li>
</ul>
<h3 id="specspec_helperrb"><a class="header" href="#specspec_helperrb">spec/spec_helper.rb</a></h3>
<p>Add SimpleCov configuration at the top of the file (before <code>RSpec.configure</code>):</p>
<pre><code class="language-ruby"># Run code coverage and exclude files with less than 5 lines of code
unless ENV["NO_COVERAGE"]
  require "simplecov"
  SimpleCov.start "rails" do
    add_filter "app/channels/application_cable/channel.rb"
    add_filter "app/channels/application_cable/connection.rb"
    add_filter "app/jobs/application_job.rb"
    add_filter "app/mailers/application_mailer.rb"
    add_filter "app/models/application_record.rb"
    add_filter ".semaphore-cache"
    enable_coverage :branch
    minimum_coverage line: 100, branch: 100
  end
end
</code></pre>
<p>Add the following configuration options inside the <code>RSpec.configure</code> block:</p>
<pre><code class="language-ruby">RSpec.configure do |config|
  # ... existing configuration ...

  config.expect_with :rspec do |expectations|
    expectations.include_chain_clauses_in_custom_matcher_descriptions = true
  end

  config.mock_with :rspec do |mocks|
    mocks.verify_partial_doubles = true
  end

  config.run_all_when_everything_filtered = true

  config.define_derived_metadata do |meta|
    meta[:aggregate_failures] = true
  end
end
</code></pre>
<p>We suggest you to also unable/uncomment the following:</p>
<pre><code class="language-ruby">config.disable_monkey_patching!
config.default_formatter = "doc" if config.files_to_run.one?
config.profile_examples = 5
config.order = :random
Kernel.srand config.seed
</code></pre>
<h3 id="specrails_helperrb"><a class="header" href="#specrails_helperrb">spec/rails_helper.rb</a></h3>
<p>Add the following requires:</p>
<pre><code class="language-ruby"># after `require "rspec/rails"`
require "capybara/rspec"
require "capybara/rails"
require "selenium/webdriver"
require "super_diff/rspec-rails"
</code></pre>
<p>Add the following after the requires (before <code>RSpec.configure</code>):</p>
<pre><code class="language-ruby">Rails.root.glob("spec/support/**/*.rb").each { |f| require f }
</code></pre>
<p>Add the following configuration inside the <code>RSpec.configure</code> block:</p>
<pre><code class="language-ruby">RSpec.configure do |config|
  # ... existing configuration ...

  config.include FactoryBot::Syntax::Methods
  config.include ActiveSupport::Testing::TimeHelpers
  config.include JavaScriptErrorReporter, type: :system, js: true
  config.include Capybara::RSpecMatchers, type: :request

  config.infer_spec_type_from_file_location!

  config.before do |example|
    ActionMailer::Base.deliveries.clear
    I18n.locale = I18n.default_locale
    Rails.logger.debug { "--- #{example.location} ---" }
  end

  config.after do |example|
    Rails.logger.debug { "--- #{example.location} FINISHED ---" }
  end

  config.before(:each, type: :system) do
    driven_by :rack_test
  end

  config.before(:all, type: :system) do
    Capybara.server = :puma, { Silent: true }
  end

  config.before(:each, type: :system, js: true) do
    driven_by ENV["SELENIUM_DRIVER"]&amp;.to_sym || :selenium_chrome_headless
    Capybara.page.current_window.resize_to(1280, 800)
  end
end
</code></pre>
<h3 id="envexample"><a class="header" href="#envexample">.env.example</a></h3>
<pre><code class="language-yml"># SELENIUM_DRIVER="selenium_chrome"
SELENIUM_DRIVER="selenium_chrome_headless"
</code></pre>
<h3 id="configenvironmentsdevelopmentrb"><a class="header" href="#configenvironmentsdevelopmentrb">config/environments/development.rb</a></h3>
<pre><code class="language-rb">config.generators do |g|
  g.test_framework :rspec
end

</code></pre>
<ul>
<li>Add the line <code>bundle exec parallel_rspec</code> to <code>bin/check</code></li>
</ul>
<blockquote>
<p><strong>Note</strong>: If you want to debug a spec, you can simply uncomment the line <code>SELENIUM_DRIVER</code> in the .env to not run it headless:</p>
</blockquote>
<p><img src="https://user-images.githubusercontent.com/1319150/123443347-1bbcae80-d5d6-11eb-8ba5-0d2c9ae4a37c.gif" alt="CleanShot 2021-06-25 at 16 54 22"></p>
<h2 id="-our-first-green-test"><a class="header" href="#-our-first-green-test">‚úÖ Our first (green) test</a></h2>
<p>We are now going to write a first test to ensure that the whole configuration is working:</p>
<ul>
<li><code>bin/check</code> should be green ‚úÖ</li>
<li>Write the test <a href="templates/spec/system/health_spec.rb"><code>spec/system/health_spec.rb</code></a></li>
<li>Run <code>bin/check</code> and the test should pass and coverage is 100%.</li>
</ul>
<p>Commit and push your changes! üéâ</p>
<blockquote>
<p>‚≠êÔ∏è The default health check path for Rails is <code>/up</code>. <a href="https://edgeapi.rubyonrails.org/classes/Rails/HealthController.html">Learn more in the Rails guides</a>.<br>To customize the health check and add additional checks, you can override the <code>Rails::HealthController</code> class.<br>You can find an example that also checks the database connection <a href="templates/app/controllers/rails/health_controller.rb">in this file</a>.</p>
</blockquote>
<h2 id="verify"><a class="header" href="#verify">Verify</a></h2>
<p>Check that you see a green page in each app.</p>
<h3 id="heroku-1"><a class="header" href="#heroku-1">Heroku</a></h3>
<ul>
<li>Open the two apps
<ul>
<li><a href="https://[project-name]-main.herokuapp.com/up">https://[project-name]-main.herokuapp.com/up</a></li>
<li><a href="https://[project-name]-develop.herokuapp.com/up">https://[project-name]-develop.herokuapp.com/up</a></li>
</ul>
</li>
</ul>
<h3 id="deploio"><a class="header" href="#deploio">Deploio</a></h3>
<p>The host name contains a generated hash. The name can be accessed via:</p>
<pre><code class="language-sh">nctl get applications --project={PROJECT_NAME}
</code></pre>
<h2 id="javascript-error-reporter"><a class="header" href="#javascript-error-reporter">Javascript error reporter</a></h2>
<ul>
<li>Create the module <a href="templates/spec/support/javascript_error_reporter.rb"><code>spec/support/javascript_error_reporter.rb</code></a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="linting-and-automatic-checks-"><a class="header" href="#linting-and-automatic-checks-">Linting and automatic checks ‚úÖ</a></h1>
<p>All Renuo projects contain (and your project must contain as well) the following linters.
Every linter consists of a gem (usually) and a command to add to our <code>bin/fastcheck</code> script.</p>
<p>Check out the <code>bin/fastcheck</code> <a href="templates/bin/fastcheck">fastcheck</a> for the final version of it.</p>
<h2 id="renuocop-"><a class="header" href="#renuocop-">Renuocop üëÆ</a></h2>
<p>Renuocop is based on Standard Ruby and is a set of rules that we use to lint our Ruby code.
It‚Äôs already included in your Gemfile by default.</p>
<p>You can execute it and correct the issues you‚Äôll find.</p>
<p><code>bundle exec rubocop -A</code> will fix <del>most</del> all of them automatically.</p>
<h2 id="brakeman"><a class="header" href="#brakeman">Brakeman</a></h2>
<p>Brakeman comes by default with Rails. Add it to the <code>bin/fastcheck</code> script.</p>
<pre><code class="language-sh">bundle exec brakeman -q -z --no-summary --no-pager
</code></pre>
<h2 id="mdl"><a class="header" href="#mdl">Mdl</a></h2>
<p>An optional check for markdown files. You can include it or not. Discuss within your team.</p>
<pre><code class="language-ruby">group :development, :test do
  gem 'mdl', require: false
end
</code></pre>
<h2 id="scss-lint"><a class="header" href="#scss-lint">SCSS lint</a></h2>
<blockquote>
<p><em>Note</em>: Your Semaphore configuration might have to be adjusted if you decide to use <code>npm</code>.</p>
</blockquote>
<p>To lint the SASS/SCSS files in our project you can use the <code>stylelint</code> npm package.</p>
<p><code>npm install stylelint stylelint-config-standard-scss</code></p>
<p>Add to the project the <a href="templates/.stylelintrc.yml">linter configuration file</a> and check the <a href="templates/bin/fastcheck"><code>bin/fastcheck</code>
template</a> to see the command to execute the SCSS linting.</p>
<h2 id="linting-against-caniuse"><a class="header" href="#linting-against-caniuse">Linting against <a href="https://caniuse.com/">caniuse</a></a></h2>
<p>You might want to check whether the JS/CSS you produce is working in your target browsers.
This can be done using the <code>browserslist</code> package and linter plugins.</p>
<h3 id="css-stylelint-no-unsupported-browser-features"><a class="header" href="#css-stylelint-no-unsupported-browser-features">CSS (stylelint-no-unsupported-browser-features)</a></h3>
<p>This plugin can either be configured directly (shown here) or use a global <code>browserslist</code> config (less flexible).</p>
<pre><code class="language-sh">npm add -D browserslist stylelint stylelint-config-standard stylelint-no-unsupported-browser-features
</code></pre>
<pre><code class="language-js title=&quot;stylelint.config.mjs&quot;">// stylelint.config.mjs
export default {
  extends: ["stylelint-config-standard"],
  "plugins": [
    "stylelint-no-unsupported-browser-features"
  ],
  "rules": {
    "plugin/no-unsupported-browser-features": [
      true,
      {
        "browsers": [
          "chrome &gt;= 112"
        ],
        "ignore": [
          "rem"
        ],
        "ignorePartialSupport": true
      }
    ]
  }
};
</code></pre>
<p>Assume the following CSS:</p>
<pre><code class="language-css title=&quot;app/assets/stylesheets/application.css&quot;">/* app/assets/stylesheets/application.css */
.layout {
  display: grid;
  grid-template-rows: auto 1fr auto;
  gap: 12px;
}

.panel {
  display: grid;
  grid-template-rows: subgrid;
  gap: 6px;
}
</code></pre>
<p>This would lead to the following linting error</p>
<pre><code class="language-sh">$ node_modules/stylelint/bin/stylelint.mjs "**/*.css" -c /Users/josua/p/tmp/eslint/stylelint.config.mjs

app/assets/stylesheets/application.css
  20:3  ‚úñ  Unexpected browser feature "css-subgrid" is not supported by Chrome 112-116  plugin/no-unsupported-browser-features

‚úñ 1 problem (1 error, 0 warnings)
</code></pre>
<h3 id="js-eslint-plugin-compat"><a class="header" href="#js-eslint-plugin-compat">JS (eslint-plugin-compat)</a></h3>
<p>This plugin can only be configured using a global <code>browserslist</code> as it seems.</p>
<pre><code class="language-sh">npm add -D eslint @eslint/js eslint-plugin-compat
</code></pre>
<pre><code class="language-js title=&quot;eslint.config.mjs&quot;">// eslint.config.mjs
import js from "@eslint/js";
import compat from "eslint-plugin-compat";

export default [
  {
    files: ["**/*.js"],
    ...js.configs.recommended,
  },
  compat.configs["flat/recommended"],
];
</code></pre>
<h2 id="erb-lint"><a class="header" href="#erb-lint">Erb lint</a></h2>
<pre><code class="language-ruby">group :development, :test do
  gem 'erb_lint', require: false
end
</code></pre>
<h2 id="eslint"><a class="header" href="#eslint">ESLint</a></h2>
<pre><code>npm install eslint
npx eslint --init (Use a popular style guide -&gt; Airbnb)
</code></pre>
<p>then extend the <code>bin/fastcheck</code> script with:</p>
<pre><code>yarn eslint app/javascript
</code></pre>
<p>The templates folder contains a template for the eslint configuration.</p>
<h2 id="all-good"><a class="header" href="#all-good">All Good!</a></h2>
<p>Now your <code>bin/fastcheck</code> is not that fast anymore üòÑ</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="suggested-gems"><a class="header" href="#suggested-gems">Suggested gems</a></h1>
<p>Here is an hopefully up-to-date version of gems which we strongly suggest to include in your project.
Please include them or find a good reason not to.</p>
<blockquote>
<p>‚ùó Please follow the guide of each of these libraries to know how to properly install them.</p>
</blockquote>
<blockquote>
<p><strong>üí°</strong> Do you know all of them? Do you know why we‚Äôd like them to be included?</p>
</blockquote>
<pre><code class="language-rb">gem 'simple_form'

group :development do
  gem 'better_errors'
  gem 'binding_of_caller'
end

group :development, :test do
  gem 'awesome_print'
  gem 'bullet'
end

group :production do
  gem 'lograge'
end
</code></pre>
<blockquote>
<p><strong>üí°</strong> Note that to install <code>simple_form</code> you need to run <code>rails generate simple_form:install --bootstrap</code> (without option if not using Bootstrap) after adding it to your Gemfile.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="cloudflare"><a class="header" href="#cloudflare">Cloudflare</a></h1>
<p>Setup Cloudflare: <a href="https://www.cloudflare.com/a/dns/renuoapp.ch">https://www.cloudflare.com/a/dns/renuoapp.ch</a></p>
<ul>
<li>Now open
<ul>
<li><a href="http://[project-name]-main.renuoapp.ch/home/check">http://[project-name]-main.renuoapp.ch/home/check</a></li>
<li><a href="http://[project-name]-develop.renuoapp.ch/home/check">http://[project-name]-develop.renuoapp.ch/home/check</a></li>
</ul>
</li>
</ul>
<p>Check that you:</p>
<ul>
<li>see ‚Äú1+2=3‚Äù in each app.</li>
<li>have been redirected to https.</li>
</ul>
<h2 id="crypto-settings"><a class="header" href="#crypto-settings">Crypto settings</a></h2>
<p>When setting up a new site on Cloudflare, make sure you set SSL to ‚ÄúFull‚Äù under Crypto settings. You may end up in endless loop of redirects if it stays on the default setting (‚ÄúFlexible‚Äù)</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="sentry"><a class="header" href="#sentry">Sentry</a></h1>
<h2 id="general-configuration"><a class="header" href="#general-configuration">General configuration</a></h2>
<ul>
<li>
<p>Go to https://www.sentry.io and login as the renuo monitor user.</p>
</li>
<li>
<p>Create a project named <code>[project-name]</code>.</p>
</li>
<li>
<p>Add the project to the <em>#renuo</em> team if the client pays for monitoring, to the <code>#no-notifications</code> otherwise.</p>
</li>
<li>
<p>Note the DSN key.</p>
<p><img src="images/sentry.png" alt="sentry_dsn"></p>
</li>
</ul>
<p>Add the ENV variables to the <code>.env</code> files for each environment.</p>
<p>Use the <strong>same</strong> <code>SENTRY_DSN</code> across all environments, but set a different <code>SENTRY_ENVIRONMENT</code> in each environment (e.g. <code>main</code>, <code>develop</code>).</p>
<p>This allows all errors to be tracked in a single Sentry project while still being grouped by environment.</p>
<p>The project‚Äôs Sentry issues can be monitored on the <a href="https://dashboard.renuo.ch/redmine_projects">Renuo Dashboard</a>. To configure this, ensure that the <code>dash</code> attribute for the project on Redmine is equal to the Sentry project name.</p>
<p>The different environments will be automatically detected, and you can monitor and view the Sentry issues from one place.</p>
<h2 id="backend-rails"><a class="header" href="#backend-rails">Backend (Rails)</a></h2>
<ul>
<li>
<p>Add sentry gems to the project:</p>
<pre><code class="language-ruby">group :production do
  gem "sentry-rails"
  gem "sentry-ruby"
end
</code></pre>
</li>
<li>
<p>Add a Sentry initializer to your project <a href="templates/config/initializers/sentry.rb"><code>config/initializers/sentry.rb</code></a>.</p>
</li>
<li>
<p>Add the following to your <code>.env.example</code> file:</p>
</li>
</ul>
<pre><code class="language-bash"># .env.example
# SENTRY_DSN="find_me_on_password_manager"
# SENTRY_ENVIRONMENT="local"
# CSP_REPORT_URI=""
</code></pre>
<ul>
<li>
<p>Enable CSP Reporting to Sentry in <code>config/initializers/content_security_policy.rb</code> and allow unsafe inline JS:</p>
<pre><code class="language-ruby">Rails.application.config.content_security_policy do |policy|
  ...
  policy.report_uri ENV['CSP_REPORT_URI'] if ENV['CSP_REPORT_URI']
end
</code></pre>
<p>You can find the correct value in <code>Sentry -&gt; Project Settings -&gt; Security Headers -&gt; REPORT URI</code>. Add the environment to the <code>CSP_REPORT_URI</code> using <code>&amp;sentry_environment=main</code>.</p>
</li>
</ul>
<h2 id="frontend-javascript"><a class="header" href="#frontend-javascript">Frontend (Javascript)</a></h2>
<ul>
<li>Install the npm package: <code>yarn add @sentry/browser</code></li>
<li>Include <a href="templates/app/views/shared/_sentry.html.erb">_sentry.html</a> in your header.</li>
<li>Include <a href="templates/app/javascript/sentry.js">sentry.js</a> in your JS assets.</li>
</ul>
<h2 id="verify-the-installation"><a class="header" href="#verify-the-installation">Verify the installation</a></h2>
<h3 id="ruby"><a class="header" href="#ruby">Ruby</a></h3>
<p>For each Heroku app, connect to the <code>heroku run rails console --app [project-name]-[branch-name]</code> and raise an exception using Sentry:</p>
<pre><code>begin
  1 / 0
rescue ZeroDivisionError =&gt; exception
  Sentry.capture_exception(exception)
end
</code></pre>
<p>On <code>https://sentry.io/renuo/[project-name]</code> you should find the exception of the ZeroDivisionError.</p>
<h3 id="javascript"><a class="header" href="#javascript">Javascript</a></h3>
<p>Open the dev console in chrome, and run</p>
<pre><code class="language-js">try {
    throw new Error('test sentry js');
} catch(e) {
    Sentry.captureException(e)
}
</code></pre>
<p>On <code>https://sentry.io/renuo/[project-name]</code> you should find ‚ÄúUncaught Error: test sentry js‚Äù.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="newrelic"><a class="header" href="#newrelic">NewRelic</a></h1>
<p>NewRelic is a service to monitor app performance.</p>
<ul>
<li>
<p>Add the following gem to your Gemfile:</p>
<pre><code class="language-ruby">group :production do
  gem 'newrelic_rpm'
end
</code></pre>
</li>
<li>
<p>Add a NewRelic configuration file <a href="templates/config/newrelic.yml"><code>config/newrelic.yml</code></a> folder.
(<strong>Note:</strong> If you are not using Heroku, adjust the app name to something else than <code>HEROKU_APP_NAME</code>)</p>
</li>
<li>
<p>Add the new variables to your Heroku environments and <code>.env</code>:</p>
<pre><code class="language-yml">NEW_RELIC_LICENSE_KEY: "from newrelic"
</code></pre>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="robotstxt"><a class="header" href="#robotstxt">robots.txt</a></h1>
<p>It is time to configure the <code>robots.txt</code> file properly, to avoid crawlers to find our develop environments.
The main environment should be the only one searchable in the end.</p>
<p>Make sure that there is a <code>robots.txt</code> file in the public folder or your project (Rails should have created it).
This file will only be used in environments where the <code>BLOCK_ROBOTS</code> environment variable is not set.
If it is set then a custom middleware catches calls to <code>/robots.txt</code></p>
<p>Add the following gem:</p>
<pre><code class="language-ruby">group :production do
  gem "norobots"
end
</code></pre>
<h2 id="setting-environment-variables"><a class="header" href="#setting-environment-variables">Setting Environment Variables</a></h2>
<h3 id="heroku-2"><a class="header" href="#heroku-2">Heroku</a></h3>
<p>Add the environment variable <code>BLOCK_ROBOTS=true</code> in your develop environment:</p>
<pre><code class="language-sh">heroku config:add BLOCK_ROBOTS=true --app [project-name]-develop
</code></pre>
<h3 id="deploio-1"><a class="header" href="#deploio-1">Deploio</a></h3>
<p>Set the environment variable using:</p>
<pre><code class="language-sh">nctl update app [app-name] --env=BLOCK_ROBOTS=true --project=[project-name]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="configure-percy"><a class="header" href="#configure-percy">Configure Percy</a></h1>
<p>Percy is a service that recognizes UI changes between pull requests. Read more about it <a href="https://percy.io">here</a></p>
<h2 id="create-a-new-project-on-the-percy-website"><a class="header" href="#create-a-new-project-on-the-percy-website">Create a new project on the Percy website.</a></h2>
<ol>
<li>Ask wg-operations to add the project to Percy.</li>
<li>Visit <a href="https://percy.io/organizations/renuo/projects/new">this</a> link.</li>
<li>Fill in the name with <code>[project-name]</code> and select the github repository of the project.</li>
</ol>
<h2 id="setup-the-ci"><a class="header" href="#setup-the-ci">Setup the CI</a></h2>
<ol>
<li>Add the PERCY_TOKEN and PERCY_PROJECT env variables to the CI.
They can be found under <code>https://percy.io/renuo/[project-name]/settings</code>.</li>
<li>Also add PERCY_TARGET_BRANCH and set it to <code>develop</code>. Like that Percy always compares the screenshots
to the develop branch.</li>
</ol>
<h2 id="setup-the-rails-application"><a class="header" href="#setup-the-rails-application">Setup the Rails application</a></h2>
<ol>
<li>Add the gem <code>percy-capybara</code> to the test group in the Gemfile and run <code>bundle install</code>.</li>
<li>Follow the setup instructions <a href="https://percy.io/docs/clients/ruby/capybara-rails#setup">here</a></li>
<li>If the application uses the gem <code>vcr</code>,
follow the instructions <a href="https://percy.io/docs/clients/ruby/capybara-rails#_web-mock/vcr-users">here</a>.</li>
</ol>
<h2 id="start-using-percy"><a class="header" href="#start-using-percy">Start using Percy</a></h2>
<p>Create a snapshot in any capybara spec by adding the following line:</p>
<p><code>Percy::Capybara.snapshot(page, name: 'name of your snapshot')</code></p>
<h2 id="when-to-add-screenshots"><a class="header" href="#when-to-add-screenshots">When to add screenshots</a></h2>
<p>Usually it‚Äôs enough to add one screenshot for each view.
In special cases you may want to add more screenshots.</p>
<h2 id="encoding"><a class="header" href="#encoding">Encoding</a></h2>
<p>For Percy to render all characters correctly, every page that has a screenshot needs to have
the header <code>&lt;meta charset="utf-8"&gt;</code>.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="staging-environment-protection"><a class="header" href="#staging-environment-protection">Staging Environment Protection</a></h1>
<p>HTTP Basic Authentication should be configured to prevent public traffic on our development applications.</p>
<h2 id="configuration-for-heroku"><a class="header" href="#configuration-for-heroku">Configuration for Heroku</a></h2>
<p>With Heroku, basic auth can be configured as follows:</p>
<p>Add <code># BASIC_AUTH: 'admin:some-memorable-password'</code> to <code>application.example.yml</code>, then run the following command:</p>
<pre><code class="language-sh">heroku config:set BASIC_AUTH='admin:[first-memorable-password]' --app [your-app]-develop
</code></pre>
<p>Finally, save the passwords in 1Password.</p>
<h2 id="configuration-for-deploio"><a class="header" href="#configuration-for-deploio">Configuration for Deploio</a></h2>
<p>On Deploio, basic auth can be configured in the following way:</p>
<pre><code class="language-sh">nctl update app {APPLICATION_NAME} --project {PROJECT_NAME} --basic-auth=true
</code></pre>
<p>Credentials can be changed like this:</p>
<pre><code class="language-sh">nctl update app {APPLICATION_NAME} --project {PROJECT_NAME} --change-basic-auth-password
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="uptimerobot-monitoring"><a class="header" href="#uptimerobot-monitoring">Uptimerobot Monitoring</a></h1>
<p>To ensure that our application is always up and running, we offer a monitoring
service to the customers.</p>
<p>When we are still developing a new application, the uptimerobot check should not be
setup to avoid premature costs. Once the go-live date is very close, we enable
the monitoring only for the <code>main</code> environment, which <em>must</em> have a paid
dyno.</p>
<h2 id="setup"><a class="header" href="#setup">Setup</a></h2>
<p>You will need Renuo-CLI to be set up and at the newest version:
<code>gem install renuo-cli</code> ‚Äì&gt; see <a href="https://github.com/renuo/renuo-cli">renuo-cli</a></p>
<ol>
<li>
<p>Run the command <code>renuo setup-uptimerobot [url]</code></p>
<ul>
<li>Where <code>url</code> is the address you want to monitor. e.g. <code>https://[project-name]-main.renuoapp.ch/up</code> or <code>https://customdomain.ch/up</code></li>
</ul>
</li>
<li>
<p>The app will ask for the <code>api-key</code> for uptimerobot. It can be found at the companies‚Äô password manager.
Paste it and press enter to continue.</p>
</li>
</ol>
<p>The command will setup the project in a paused state. You can start it once your app has a paid dyno.</p>
<p><strong>Until then do not start the monitoring.</strong></p>
<h2 id="examples-1"><a class="header" href="#examples-1">Examples</a></h2>
<ul>
<li><code>renuo setup-uptimerobot https://germann.ch/up</code></li>
</ul>
<h2 id="replacing-monitors"><a class="header" href="#replacing-monitors">Replacing monitors</a></h2>
<p>It‚Äôs cumbersome to exchange a monitor for all projects.
You can utilize this script for that:</p>
<pre><code class="language-rb">require "json"
require "open3"

API_KEY = "XXX"
OFFSET = 0 # default page size is 50

# Use Open3 to capture stdout and stderr to avoid shell-specific parsing issues
monitors_response, stderr, status = Open3.capture3("curl -X POST -H \"Content-Type: application/x-www-form-urlencoded\" -H \"Cache-Control: no-cache\" -d 'api_key=#{API_KEY}&amp;format=json&amp;alert_contacts=1&amp;offset=#{OFFSET}' \"https://api.uptimerobot.com/v2/getMonitors\" | jq -c '[.monitors[] | {id: .id, alert_contacts: .alert_contacts}]'")

unless status.success?
  puts "Error executing command: #{stderr}"
  exit
end

monitors = JSON.parse(monitors_response)
monitors.each do |monitor|
  id = monitor["id"]

  # Add your new monitor here so that it is added to all projects
  monitor["alert_contacts"] &lt;&lt; { "id" =&gt; raise("TODO: replace this"), "threshold" =&gt; 0, "recurrence" =&gt; 0 }

  alert_contacts = monitor["alert_contacts"].map { |contact|
    contact.values_at("id", "threshold", "recurrence").compact.join("_")
  }.join("-")

  cmd = %(curl -X POST -H "Cache-Control: no-cache" -H "Content-Type: application/x-www-form-urlencoded" -d 'api_key=#{API_KEY}&amp;format=json&amp;id=#{id}&amp;alert_contacts=#{alert_contacts}' "https://api.uptimerobot.com/v2/editMonitor")
  puts cmd
end
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="depfu"><a class="header" href="#depfu">Depfu</a></h1>
<p>Depfu is a service which checks out the Gemfile / yarn.lock of a project for problematic
dependencies. It will automatically create a pull request to the project
if a security vulnerability has been disclosed.</p>
<ol>
<li>Ask wg-operations to add repository access for Depfu to you new Github
repository.</li>
</ol>
<p>That‚Äôs all :-)</p>
<p>Update strategy should be set to <code>Grouped Updates</code>, frequency: <code>monthly</code>. Assignee should be set.</p>
<h2 id="engine-updates"><a class="header" href="#engine-updates">Engine Updates</a></h2>
<p>Enable minor engine updates.</p>
<p><img src="images/depfu_engine_updates.png" alt="Depfu Engine Updates"></p>
<p><strong>Note:</strong> If you are using Heroku, the latest Ruby / node version may not yet
be available on their platform, so you may need to delay the upgrade. Check the
following GitHub repositories to see if Heroku added support already:</p>
<ul>
<li><a href="https://github.com/heroku/heroku-buildpack-nodejs">https://github.com/heroku/heroku-buildpack-nodejs</a></li>
<li><a href="https://github.com/heroku/heroku-buildpack-ruby">https://github.com/heroku/heroku-buildpack-ruby</a></li>
</ul>
<h2 id="automatic-merging"><a class="header" href="#automatic-merging">Automatic merging</a></h2>
<p>To speed up the merging of smaller upgrades (like security fixes) we enable
Automatic merging like this:</p>
<p><img src="images/depfu_automatic_merging.png" alt="Depfu Automatic Merging"></p>
<p>Since PRs need to be approved before depfu can merge them we add a GitHub
Actions workflow to automatically approve PRs from depfu:</p>
<pre><code class="language-yaml"># .github/workflows/depfu_autoapprove.yml
name: Depfu auto-approve
on:
  pull_request_target:
    types: [opened]

permissions:
  pull-requests: write

jobs:
  depfu:
    runs-on: ubuntu-latest
    if: ${{ github.actor == 'depfu[bot]' }}
    steps:
      - name: Approve all depfu PRs
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
</code></pre>
<h2 id="ticket-reference"><a class="header" href="#ticket-reference">Ticket reference</a></h2>
<p>In order to avoid searching for the maintenance project after reviewing a Depfu PR,
we add the ticket to the PR title according to the following Depfu configuration:</p>
<p><img src="images/depfu_pr_title.png" alt="Depfu Redmine Ticket PR Title"></p>
<p>Make sure that the ticket number matches the actual maintenance ticket.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="run-javascript-tests-with-jest"><a class="header" href="#run-javascript-tests-with-jest">Run Javascript tests with Jest</a></h1>
<p>When you start writing Javascript code, you have to test it. Webpacker doesn‚Äôt come (yet) with a default test tool.
Here is a configuration suggestion to start testing using Jest.</p>
<ul>
<li>Install Jest</li>
</ul>
<pre><code class="language-bash">./bin/yarn add --dev jest
</code></pre>
<ul>
<li>Add the following to the <code>package.json</code></li>
</ul>
<pre><code class="language-json">  "scripts": {
    "test": "jest --coverage"
  },
  "jest": {
    "roots": [
      "spec/javascripts"
    ],
    "setupFiles": [
      "./spec/javascripts/setup-jest.js"
    ],
    "coverageThreshold": {
      "global": {
        "branches": 100.0,
        "functions": 100.0,
        "lines": 100.0,
        "statements": 100.0
      }
    },
    "coverageDirectory": "./coverage/jest"
  }
</code></pre>
<p>This creates a <code>yarn test</code> command which runs your tests, including coverage.
It also configures the root of your tests into spec/javascripts folder and the coverage thresholds.</p>
<ul>
<li>Create the file <code>spec/javascripts/setup-jest.js</code> and, if you are using JQuery, add:</li>
</ul>
<pre><code class="language-js">import $ from 'jquery';
global.$ = global.jQuery = $;
</code></pre>
<p>In this file you create the configuration that is necessary before running the tests.</p>
<ul>
<li>Add the following to your <code>.babelrc</code> configuration file:</li>
</ul>
<pre><code>"env": {
  "test": {
    "plugins": ["@babel/plugin-transform-modules-commonjs"]
  }
}
</code></pre>
<p>Now you can run your tests with <code>yarn test</code> and they should fail because you don‚Äôt have any test.</p>
<p>Add your Javascript tests check run to <code>bin/check</code>:</p>
<pre><code>bin/yarn test
if [ $? -ne 0 ]; then
  echo 'Javascript tests did not run successfully, commit aborted'
  exit 1
fi
</code></pre>
<p>Add your tests to the <code>spec/javascripts</code> folder,
naming them <code>yourtest.spec.js</code> to be automatically recognised by Jest as tests.</p>
<p>A template for a test could be the following:</p>
<pre><code class="language-js">// spec/javascripts/my_class.spec.js

import MyClass from '../../app/webpacker/src/javascripts/my_class';

describe('MyClass', () =&gt; {

  beforeEach(() =&gt; {
    ...
  });

  describe('#amethod', () =&gt; {
    it('runs a test', () =&gt; {
      new MyClass();
      expect(1).toEqual(2);
    });
  });
});

</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="-send-emails"><a class="header" href="#-send-emails">üì´ Send Emails</a></h1>
<p>As soon as you have to send emails please follow those suggestions.
They will help you having a proper system to deliver emails and development environment.</p>
<h2 id="configuration-1"><a class="header" href="#configuration-1">Configuration</a></h2>
<ul>
<li>Add the following to your Gemfile and <code>bundle install</code></li>
</ul>
<pre><code class="language-ruby">group :development do
  gem 'letter_opener'
end
</code></pre>
<ul>
<li>add the following to <code>.env.example</code></li>
</ul>
<pre><code class="language-yml">APP_HOST="[project-name].localhost"
APP_PORT="3000"
MAIL_SENDER="yourname+&lt;application&gt;@example.com"
MAIL_HOST=""
MAIL_USERNAME=""
MAIL_PASSWORD=""
</code></pre>
<ul>
<li>update <code>app/mailers/application_mailer.rb</code></li>
</ul>
<pre><code class="language-ruby">class ApplicationMailer &lt; ActionMailer::Base
  default from: ENV.fetch('MAIL_SENDER')  # &lt;-- change this
  layout 'mailer'
end
</code></pre>
<ul>
<li>add the following to <code>config/application.rb</code></li>
</ul>
<pre><code class="language-ruby">config.action_mailer.default_url_options = { host: ENV.fetch('APP_HOST'), port: ENV.fetch('APP_PORT') }
</code></pre>
<ul>
<li>add the following to <code>config/environments/development.rb</code>:</li>
</ul>
<pre><code class="language-ruby">config.action_mailer.delivery_method = :letter_opener
</code></pre>
<ul>
<li>add the following <code>config/environments/production.rb</code>:</li>
</ul>
<pre><code class="language-ruby">config.action_mailer.smtp_settings = {
  address: ENV.fetch('MAIL_HOST'),
  port: 587,
  enable_starttls_auto: true,
  user_name: ENV.fetch('MAIL_USERNAME'),
  password: ENV.fetch('MAIL_PASSWORD'),
  authentication: 'login',
  domain: ENV.fetch('APP_HOST')
}
</code></pre>
<h2 id="sparkpost--mailtrap"><a class="header" href="#sparkpost--mailtrap">Sparkpost &amp; Mailtrap</a></h2>
<p>Follow the <a href="#sparkpost--mailtrap-1">sparkpost</a> section to configure Sparkpost and Mailtrap on your production environment</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="sparkpost--mailtrap-1"><a class="header" href="#sparkpost--mailtrap-1">SparkPost &amp; Mailtrap</a></h1>
<p>‚ö†Ô∏è Always use subaccounts in Sparkpost!</p>
<blockquote>
<p>Otherwise there may be compliance issues which can lead to the closing down of the whole Renuo account.</p>
</blockquote>
<h2 id="introduction"><a class="header" href="#introduction">Introduction</a></h2>
<p><strong>Main (Sparkpost, sample-app@yourdomain.tld)</strong></p>
<ul>
<li>Each app is using a separate subaccount under the main account</li>
<li>The Domain should be set up and verified under the subaccount‚Äôs sending domains</li>
<li>Login: sparkpost+main@renuo.ch</li>
</ul>
<p><strong>Develop (Sparkpost, renuoapp.ch)</strong></p>
<ul>
<li>
<p>Each app is using a separate subaccount under the main account</p>
</li>
<li>
<p>The emails will be sent with <strong>*@renuoapp.ch</strong> as your mail sender</p>
</li>
<li>
<p>Login: sparkpost+develop@renuo.ch</p>
</li>
<li>
<p>If you want, you can also use Mailtrap for develop. Create a new Inbox <a href="https://mailtrap.io/inboxes">https://mailtrap.io/inboxes</a> and use this credentials</p>
</li>
</ul>
<p><strong>Testing (Mailtrap)</strong></p>
<ul>
<li>Login: operations@renuo.ch</li>
<li>The Email will be caught by Mailtrap and not forwarded to the intended receiver</li>
<li>You can login to Mailtrap to see the sent email</li>
</ul>
<h2 id="sparkpost"><a class="header" href="#sparkpost">Sparkpost</a></h2>
<p>‚ö†
Always use subaccounts for the project, so that the whole account doesn‚Äôt get suspended / blocked in case of compliance issues!</p>
<ol>
<li>Go to <a href="https://app.sparkpost.com/auth">https://app.sparkpost.com/auth</a> and log in with the credentials for
sparkpost+<em>enviroment</em>@renuo.ch found in the credential store</li>
<li>Create <a href="https://app.sparkpost.com/account/subaccounts">one new subaccount</a> and name it like your project</li>
<li>Create <a href="https://app.sparkpost.com/account/api-keys/create">a new API-Key for your subaccount</a> and assign it to the new subaccount, with the following permissions: <em>Send via SMTP, Sending Domains: Read/Write</em></li>
<li>Write down the API-key in the credential store (in a list under sparkpost+<em>enviroment</em>@renuo.ch), because it‚Äôs only showed once!</li>
<li>Credentials for SMTP setup on your app can be found <a href="https://app.sparkpost.com/account/smtp">here</a>, password is your generated API-key</li>
<li>(if domain is known) Add your sending domain
<a href="https://app.sparkpost.com/domains/create?type=sending">here</a>. Assign it to
the subaccount. Set up SPF, DKIM and DMARC with TXT DNS records (only use
<code>renuoapp.ch</code> within the <code>sparkpost+develop@renuo.ch</code>)</li>
<li>Verify your Email DNS configuration with <a href="https://mxtoolbox.com/SuperTool.aspx">https://mxtoolbox.com/SuperTool.aspx</a></li>
<li>Set up your ENV-variables and test if the mails are working. Manual test emails can be send via the following command in the rails console (production environment): <code>ActionMailer::Base.mail(to: 'yourname@renuo.ch', from: ENV['MAIL_SENDER'], subject: 'Testmail', body: 'Mail content').deliver_now!</code></li>
<li>Send a test email to <a href="https://www.mail-tester.com/">https://www.mail-tester.com/</a> or <a href="https://www.experte.com/spam-checker">https://www.experte.com/spam-checker</a> and check the result</li>
</ol>
<p>For DNS setup also see <a href="#go-live">Go Live</a></p>
<p>ENV-variables example:</p>
<pre><code>MAIL_USERNAME: 'SMTP_Injection'
MAIL_PASSWORD:  'YOUR API KEY'
MAIL_HOST: 'smtp.sparkpostmail.com'
MAIL_SENDER: 'Sample App &lt;sample-app@renuoapp.ch&gt;'
</code></pre>
<p>Or with a custom domain:</p>
<pre><code>MAIL_SENDER: 'Sample App &lt;sample-app@yourdomain.tld&gt;'
</code></pre>
<h2 id="mailtrap"><a class="header" href="#mailtrap">Mailtrap</a></h2>
<p>ENV-variables example:</p>
<pre><code>MAIL_USERNAME: 'found in credential store'
MAIL_PASSWORD:  'found in credential store'
MAIL_HOST: 'smtp.mailtrap.io'
MAIL_SENDER: 'Sample App &lt;sample-app@yourdomain.tld&gt;'
</code></pre>
<p>Set up your ENV-variables and test if the mails are working. Manual test emails can be send via the following command in the rails console (production environment): <code>ActionMailer::Base.mail(to: 'yourname@renuo.ch', from: ENV['MAIL_SENDER'], subject: 'Testmail', body: 'Mail content').deliver_now!</code></p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="devise"><a class="header" href="#devise">Devise</a></h1>
<p>‚ö† If you are going to use devise we suggest you to <a href="#-send-emails">send_emails</a> first. ‚ö†</p>
<ul>
<li>Add the following gem <code>gem 'devise'</code> and install it</li>
</ul>
<pre><code class="language-sh">bundle install
rails generate devise:install
</code></pre>
<ul>
<li>update <code>config/initializers/devise.rb</code> and set</li>
</ul>
<pre><code class="language-rb">config.secret_key = ENV['DEVISE_SECRET_KEY']
config.mailer_sender = ENV['MAIL_SENDER']
config.pepper = ENV['DEVISE_PEPPER']
</code></pre>
<ul>
<li>add the two variables to the <code>.env.example</code></li>
</ul>
<pre><code class="language-bash">DEVISE_SECRET_KEY="rake secret"
DEVISE_PEPPER="rake secret"
</code></pre>
<p>Open a pull request! üéâ</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="cucumber"><a class="header" href="#cucumber">Cucumber</a></h1>
<p><a href="https://cucumber.io">Cucumber</a> is a testing framework which allows us to specify feature tests using plain language.
We use Cucumber for e2e tests in some of our projects. We integrate it using the <code>cucumber-rails</code> gem.</p>
<h2 id="installing-cucumber-rails"><a class="header" href="#installing-cucumber-rails">Installing <code>cucumber-rails</code></a></h2>
<p>The installation process of <code>cucumber-rails</code> is also documented on its
<a href="https://github.com/cucumber/cucumber-rails">Github page</a>.</p>
<p>To install <code>cucumber-rails</code>, add the following gems to your Gemfile:</p>
<pre><code class="language-rb">group :test do
    gem 'capybara', require: false
    gem 'cucumber-rails', require: false
    gem 'database_cleaner'
end
</code></pre>
<p>Run <code>bundle install</code> to install the gems.</p>
<p>Finally, set up Cucumber with</p>
<pre><code class="language-sh">rails generate cucumber:install
</code></pre>
<p>At this time, it is recommended to inspect the generated files and commit. Before committing, make sure, Rubocop does
not raise any issues. Therefore, you will have to add the following exception to <code>.rubocop.yml</code>:</p>
<pre><code class="language-yaml">AllCops:
  Exclude:
    - 'lib/tasks/cucumber.rake'
</code></pre>
<h2 id="running-your-first-cucumber-test"><a class="header" href="#running-your-first-cucumber-test">Running your first Cucumber test</a></h2>
<p>If you add Cucumber to an existing project, test a real page instead of using the given example test.</p>
<p>Add the following files:</p>
<ul>
<li><a href="templates/app/controllers/home_controller.rb"><code>app/controllers/home_controller.rb</code></a> (If you haven‚Äôt done so
already) in the <a href="#setup-rspec">RSpec</a> section.</li>
<li><a href="templates/features/home_check.feature"><code>features/home_check.feature</code></a></li>
<li><a href="templates/features/step_definitions/home_check_steps.rb"><code>features/step_definitions/home_check_steps.rb</code></a></li>
</ul>
<p>Now, you can run Cucumber in your terminal:</p>
<pre><code class="language-sh">cucumber
</code></pre>
<p>You may get a couple of deprecation warnings. There is currently an
<a href="https://github.com/cucumber/cucumber-rails/issues/346">issue</a> about them on the Github page of <code>rspec-rails</code></p>
<h2 id="adding-cucumber-tests-to-bincheck"><a class="header" href="#adding-cucumber-tests-to-bincheck">Adding Cucumber tests to <code>bin/check</code></a></h2>
<p>Add the following code to <code>bin/check</code>, so the Cucumber tests are run on CI:</p>
<pre><code class="language-sh">NO_COVERAGE=true bundle exec cucumber --format progress
if [ $? -ne 0 ]; then
  echo 'Cucumber did not run successfully, commit aborted'
  exit 1
fi
</code></pre>
<p>Assure that <code>bin/check</code> fails, if you have a broken Cucumber test.</p>
<h2 id="custom-environment"><a class="header" href="#custom-environment">Custom environment</a></h2>
<p>Probably, you are going to need the following configuration files in <code>/features/env</code>:</p>
<ul>
<li><a href="templates/features/env/capybara.rb"><code>capybara.rb</code></a> enables headless Chrome. This is needed in Cucumber tests
which require Javascript (i.e. scenarios tagged with <code>@javascript</code>).</li>
<li><a href="templates/features/env/database_cleaner.rb"><code>database_cleaner.rb</code></a> sets up <code>database_cleaner</code> for Cucumber tests.</li>
<li><a href="templates/features/env/factory_bot.rb"><code>factory_bot.rb</code></a> makes FactoryBot‚Äôs methods (like <code>build</code> and <code>create</code>)
accessible in the step definition file.</li>
<li><a href="templates/features/env/warden.rb"><code>warden.rb</code></a> sets up the test environment, if you are using Warden (i.e. if you
are using Devise).</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="object-storage"><a class="header" href="#object-storage">Object Storage</a></h1>
<h2 id="deploio-2"><a class="header" href="#deploio-2">Deploio</a></h2>
<h3 id="command-generation"><a class="header" href="#command-generation">Command generation</a></h3>
<p>The following command will generate command-line-commands to set up object storage on Deploio.
You‚Äôll need to run them by yourself after reviewing the output.</p>
<ol>
<li>
<p>Run <code>renuo create-deploio-object-storage</code></p>
</li>
<li>
<p>Follow the steps and answer the questions</p>
</li>
<li>
<p>Now it will print you out a series of commands e.g.:</p>
<pre><code class="language-sh"># Deploio main

    nctl create bucketuser main --project &lt;&lt;your-project&gt;&gt; --location &lt;&lt;location&gt;&gt;
    [...]
    nctl get bucketuser main --project &lt;&lt;your-project&gt;&gt; --print-credentials
    [...]

# Deploio develop
[...]
</code></pre>
</li>
<li>
<p>Review the commands carefully (e.g. make sure that you enable bucket versioning for the main branch)</p>
</li>
</ol>
<p>If you think that the script is outdated, please open a Pull Request on the <a href="https://github.com/renuo/renuo-cli">renuo-cli</a> project.</p>
<p>For further configuration and best practices, please refer to the <a href="https://guides.deplo.io/ruby/object-storage.html#setup-object-storage">Deploio documentation</a>.</p>
<h2 id="aws"><a class="header" href="#aws">AWS</a></h2>
<p>The following Amazon services are involved in our app setups</p>
<ul>
<li>Amazon <strong>S3</strong> is Amazon‚Äôs Simple Cloud Storage Service,
and used in most of your projects to store images and files.</li>
<li>Amazon <strong>CloudFront</strong> is a large scale, global, and feature rich CDN.
We mostly use it together with S3 to provide a proper HTTP endpoint (caching, header forwarding, etc.).
You could also host a Single Page Application (SPA).</li>
<li>Amazon <strong>ACM</strong> issues certificates which can be used for custom Cloudfront distribution domains</li>
<li>Amazon <strong>IAM</strong> issues resource policies.
<ul>
<li>We use a special ‚Äúrenuo-app-setup‚Äù user to setup our projects.</li>
<li>Each app has an own user to separate tenants properly. The user belongs to ‚Äúrenuo-apps-v2‚Äù</li>
<li>You can find a graphical overview in <a href="https://docs.google.com/presentation/d/1E-6hQB7ZezsVlkESEQVJmdZtdTUWRalT8XjkriurIQc/edit#slide=id.g3ba9e981d1_0_7">this lightning talk</a>.</li>
</ul>
</li>
</ul>
<h2 id="setup-1"><a class="header" href="#setup-1">Setup</a></h2>
<h3 id="preconditions"><a class="header" href="#preconditions">Preconditions</a></h3>
<h4 id="renuo-cli"><a class="header" href="#renuo-cli">renuo-cli</a></h4>
<p>You will need Renuo-CLI to be set up and at the newest version:</p>
<p><code>gem install renuo-cli</code> ‚Äì&gt; see <a href="https://github.com/renuo/renuo-cli">renuo-cli</a></p>
<p>Make sure <code>renuo -v</code> shows the <a href="https://github.com/renuo/renuo-cli/tags">newest version</a></p>
<h4 id="aws-cli"><a class="header" href="#aws-cli">aws-cli</a></h4>
<p>Retrieve the credentials ‚ÄúAWS Profile ‚Äòrenuo-app-setup‚Äô for s3 setup‚Äù from the password manager at first (or ask <em>wg-operations</em> for help).</p>
<p>You‚Äôll need to use <code>aws-cli</code>. You can either just continue with ‚ÄúStart the Setup‚Äù. The command will ensure that everything is set up properly.
Or you can install it manually:</p>
<pre><code>brew install awscli
aws configure --profile renuo-app-setup
</code></pre>
<p>If you want to check your config, run <code>aws configure --profile renuo-app-setup list</code>.</p>
<p>We would recommend setting default region name to <code>eu-central-1</code>. The default output format is json and should not be changed.</p>
<h3 id="aws-command-generation"><a class="header" href="#aws-command-generation">AWS Command generation</a></h3>
<p>The following command will generate command-line-commands to set up S3 and CloudFront.
You‚Äôll need to run them by yourself after reviewing the output.</p>
<ol>
<li>
<p>Run <code>renuo create-aws-project</code></p>
</li>
<li>
<p>Follow the steps and answer the questions</p>
</li>
<li>
<p>Now it will print you out a series of commands e.g.:</p>
<pre><code class="language-sh"># AWS main

    aws --profile renuo-app-setup iam create-user --user-name &lt;&lt;your-project&gt;&gt;
    [...]

# AWS develop
[...]
</code></pre>
</li>
<li>
<p>Review the commands carefully (e.g. make sure that you enable bucket versioning)</p>
</li>
</ol>
<h3 id="executing-the-commands"><a class="header" href="#executing-the-commands">Executing the commands</a></h3>
<p>Running the commands will print some JSON pages to your screen.
<strong>Copy each <code>SecretAccessKey</code> and <code>AccessKeyId</code> to your credentials store!</strong></p>
<p>Once you have worked through the commands, you are ready to use S3 for Active Storage within your Rails app by configuring the storage.yml file (as below) and setting <code>config.active_storage.service = :amazon</code> in your production.rb file.</p>
<h3 id="custom-cloudfront-distribution-cname-aliases"><a class="header" href="#custom-cloudfront-distribution-cname-aliases">Custom Cloudfront Distribution CNAME Aliases</a></h3>
<p>If you want to serve your S3 bucket via a custom domain, you need to add the CNAMEs to
your Cloudfront Distibution manually.</p>
<ol>
<li>Visit <a href="https://us-east-1.console.aws.amazon.com/cloudfront/v3/home?region=eu-central-1#/distributions">https://us-east-1.console.aws.amazon.com/cloudfront/v3/home?region=eu-central-1#/distributions</a> and edit
your distribution.</li>
<li>Enter the CNAMEs as aliases</li>
<li>Click ‚ÄúRequest certificate‚Äù (this opens a new tab with Amazon ACM, make sure it‚Äôs region is us-east-1)</li>
<li>Enter all the CNAMEs you want to have as aliases (normally only one)</li>
<li>Enter the domain ownership verification records into Cloudflare (CNAME with cryptic values)</li>
<li>Submit the ACM form and wait for the certificate to being issued.</li>
<li>Go back to the Cloudfront distribution, refresh the certifactes drop down and choose your new certificate.</li>
<li>Save the changes to the Cloudfront distribution.</li>
</ol>
<h3 id="rails-configuration"><a class="header" href="#rails-configuration">Rails Configuration</a></h3>
<p>You then can use an <em>ActiveStorage</em> configuration like this:</p>
<pre><code class="language-yaml">amazon:
  service: S3
  access_key_id: &lt;%= ENV['AWS_S3_ACCESS_KEY_ID'] %&gt;
  secret_access_key: &lt;%= ENV['AWS_S3_SECRET_ACCESS_KEY'] %&gt;
  bucket: &lt;%= ENV['AWS_S3_BUCKET'] %&gt;
  region: "eu-central-1"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="bootstrap"><a class="header" href="#bootstrap">Bootstrap</a></h1>
<p>You can use the npm package of the latest version of Bootstrap.</p>
<p><code>yarn add bootstrap</code></p>
<p>and include it in your stylesheet pack with:</p>
<pre><code class="language-scss">@import '~bootstrap/scss/bootstrap';
</code></pre>
<p>If you want to use also the javascript part of Bootstrap you need both popper.js and jquery.
Add them with:</p>
<p><code>yarn add jquery popper.js</code></p>
<p>and configure them in <code>environment.js</code>:</p>
<pre><code class="language-js">const webpack = require('webpack')
environment.plugins.append('Provide', new webpack.ProvidePlugin({
  $: 'jquery',
  jQuery: 'jquery',
  Popper: ['popper.js', 'default']
}));
</code></pre>
<p>Change <code>extract_css: false</code> to <code>extract_css: true</code> in <code>config/webpacker.yml</code></p>
<p>and finally, import bootstrap library in <code>application.js</code> with</p>
<pre><code class="language-js">import 'bootstrap/dist/js/bootstrap';
</code></pre>
<h2 id="simple-form"><a class="header" href="#simple-form">Simple Form</a></h2>
<p>If you use the gem <a href="https://github.com/plataformatec/simple_form">Simple Form</a>,
you need to adjust the configuration in the <code>config/initializers/simple_form.rb</code> file.</p>
<p>Here are some recommended options:</p>
<pre><code class="language-ruby">config.wrappers :default, class: 'form-group',
                hint_class: :field_with_hint, error_class: 'has-danger' do |b|
</code></pre>
<pre><code class="language-ruby">config.error_notification_class = 'alert alert-danger'
</code></pre>
<pre><code class="language-ruby">b.use :error, wrap_with: { tag: :span, class: 'invalid-feedback' }
</code></pre>
<pre><code class="language-ruby">config.label_class = 'form-control-label'
</code></pre>
<pre><code class="language-ruby">config.input_class = 'form-control'
</code></pre>
<p>To make the error highlighting work you need to add some css to your application</p>
<pre><code class="language-scss">.invalid-feedback {
  display: block;
}

.has-danger {
  .form-control {
    border-color: $form-feedback-invalid-color;
  }
}
</code></pre>
<p>Please note that this is a workaround, as there is yet no way to add an error class directly onto an input.
However, there is an open issue on Simple Form: <a href="https://github.com/plataformatec/simple_form/pull/147">https://github.com/plataformatec/simple_form/pull/147</a>
Once this feature is added, please remove the css.</p>
<p>For the styling of the pull down date selectors or checkboxes, you need to write some wrappers, that you can add
to the input element.
It is best to create a separate config file for this.</p>
<p>Once the issue <a href="https://github.com/plataformatec/simple_form/pull/1337">https://github.com/plataformatec/simple_form/pull/1337</a> is done, you can also configure simple form
with the command <code>rails generate simple_form:install --bootstrap4</code>.</p>
<pre><code class="language-ruby"># config/initializers/simple_form_bootstrap.rb

SimpleForm.setup do |config|
  config.wrappers :inline_date, tag: 'div', error_class: 'has-danger' do |b|
    b.use :html5
    b.use :label, class: 'control-label'
    b.wrapper tag: 'div', class: 'form-inline row' do |ba|
      ba.use :input, class: 'form-control form-inline', wrap_with: { class: 'col-md-6' }
      ba.use :error, wrap_with: { tag: 'span', class: 'invalid-feedback' }
      ba.use :hint, wrap_with:  { tag: 'p', class: 'help-block' }
    end
  end

  config.wrappers :inline_checkbox, tag: 'div', class: 'control-group', error_class: 'has-error' do |b|
    b.use :html5
    b.wrapper tag: 'div', class: 'controls' do |ba|
      ba.use :label_input, wrap_with: { class: 'checkbox inline' }
      ba.use :error, wrap_with: { tag: 'span', class: 'help-inline' }
      ba.use :hint, wrap_with: { tag: 'p', class: 'help-block' }
    end
  end

  config.wrapper_mappings = {
    check_boxes: :inline_checkbox,
    date: :inline_date,
    datatime: :inline_date
  }
end

</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="font-awesome"><a class="header" href="#font-awesome">Font-Awesome</a></h1>
<p>You can either include font-awesome through their CDN or install it via npm/yarn.</p>
<h2 id="installation-with-yarn"><a class="header" href="#installation-with-yarn">Installation with yarn</a></h2>
<h3 id="set-up"><a class="header" href="#set-up">Set up</a></h3>
<h4 id="pro-version"><a class="header" href="#pro-version">PRO version</a></h4>
<ol>
<li>Look up the auth token which can be found <a href="https://fontawesome.com/account">here</a>. The credentials can be found on passwork</li>
<li>Follow <a href="https://fontawesome.com/how-to-use/on-the-web/setup/using-package-managers#installing-pro">these steps</a> to set up <em>font-awesome</em> pro either per project or globally.</li>
</ol>
<h4 id="free"><a class="header" href="#free">Free</a></h4>
<p>For the free version of <em>font-awesome 5</em> just run <code>yarn add @fortawesome/fontawesome-free</code></p>
<h3 id="inclusion-for-webpacker"><a class="header" href="#inclusion-for-webpacker">Inclusion for Webpacker</a></h3>
<p>Include this code in your <code>stylesheets.scss</code></p>
<pre><code>$fa-font-path: '~@fortawesome/fontawesome-free/webfonts';
@import '~@fortawesome/fontawesome-free/scss/fontawesome';
@import '~@fortawesome/fontawesome-free/scss/solid';
</code></pre>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<ol>
<li>Navigate to the <a href="https://fontawesome.com/icons?d=gallery">font-awesome gallery list</a></li>
<li>Search for the icon that you wish to include and copy paste the <code>&lt;i&gt;</code> tag into your application:
For example for the Angular symbol I can just use this tag: <code>&lt;i class="fab fa-angular"&gt;&lt;/i&gt;</code></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="bullet"><a class="header" href="#bullet">Bullet</a></h1>
<p>We don‚Äôt like N+1 queries. Nobody does.
If you don‚Äôt know what we are talking about,
please read <a href="https://www.sitepoint.com/silver-bullet-n1-problem/">this article</a> that explains it pretty well.</p>
<p>In order to identify possible N+1 queries, we use the gem <a href="https://github.com/flyerhzm/bullet"><code>bullet</code></a>.</p>
<p>Please add the gem to both <code>development</code> and <code>test</code> group of the Gemfile since we‚Äôll use it also in our tests.</p>
<p>Those are our favourite configurations:</p>
<ul>
<li>in development we enable it and we see the issues both a footer in the page and also in the logs</li>
</ul>
<pre><code class="language-ruby"># config/environments/development.rb

config.after_initialize do
  Bullet.enable = true
  Bullet.bullet_logger = true
  Bullet.add_footer = true
end
</code></pre>
<ul>
<li>in test we enable it and raise an exception in case a N+1 is identified (or an unused eager loading)</li>
</ul>
<pre><code class="language-ruby"># config/environments/test.rb

config.after_initialize do
  Bullet.enable = true
  Bullet.bullet_logger = true
  Bullet.raise = true
end
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="logs--error-monitoring-with-appsignal"><a class="header" href="#logs--error-monitoring-with-appsignal">Logs &amp; error monitoring with AppSignal</a></h1>
<p>AppSignal is a service to record logs, monitor errors and performance.
Recording logs works independently from the tech stack. So you should use AppSignal
to record logs even if you don‚Äôt use Rails. In Heroku we‚Äôll add a log drain to
redirect the multiplexed Logplex logs to AppSignal in any case.</p>
<ol>
<li><a href="#backend">Backend</a></li>
<li><a href="#frontend">Frontend</a></li>
<li><a href="#verify-the-installation-1">Verify the installation</a></li>
</ol>
<h2 id="backend"><a class="header" href="#backend">Backend</a></h2>
<h3 id="logs--errors"><a class="header" href="#logs--errors">Logs &amp; errors</a></h3>
<p>If you want to log errors and metrics, you need to install the AppSignal agent
into your app. See integration instructions for <a href="https://docs.appsignal.com/logging/platforms/integrations/ruby.html">Ruby/Rails</a>.</p>
<ul>
<li>
<p>Add the following gem to your Gemfile (our fork adds a configurable sampling rate to reduce logging costs):</p>
<pre><code class="language-ruby">gem 'appsignal', github: 'renuo/appsignal-ruby'
</code></pre>
</li>
<li>
<p>Add a AppSignal configuration file <a href="templates/config/initializers/appsignal.rb"><code>config/initializers/appsignal.rb</code></a></p>
</li>
<li>
<p>Add the new variables to your Heroku environments:</p>
<pre><code class="language-yml">APPSIGNAL_APP_ENV: "main | develop"
APPSIGNAL_APP_NAME: "project name without env"
APPSIGNAL_IGNORE_ERRORS: "ActiveRecord::RecordNotFound,ActionController::UnknownFormat"
APPSIGNAL_PUSH_API_KEY: "from appsignal"
# APPSIGNAL_SAMPLING_RATE: "1.0'
</code></pre>
</li>
</ul>
<p>We use the same push key for all apps. You can either copy it from another project or ‚Äúcreate‚Äù an app on appsignal.
This will just show you the key and tell you to deploy the app with it for the app to be created.</p>
<p>Once you deploy the app and collect data the app will show up in the appsignal dashboard.
Navigate to <strong>Logging</strong> -&gt; <strong>Manage Resources</strong> and <strong>Add log resource</strong> with these settings:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Setting</th><th>Value</th></tr>
</thead>
<tbody>
<tr><td>Source name</td><td><code>Rails</code></td></tr>
<tr><td>Platform</td><td><code>Heroku Log Drain</code></td></tr>
<tr><td>Message format</td><td><code>logfmt</code></td></tr>
</tbody>
</table>
</div>
<p>Then add this ingestion endpoint as a log drain using the Heroku commands displayed.</p>
<h3 id="only-logs"><a class="header" href="#only-logs">Only Logs</a></h3>
<p>Choose the ‚ÄúJavaScript‚Äù option on the AppSignal project page to
setup your project without an active agent.</p>
<h3 id="configuration-adjustments"><a class="header" href="#configuration-adjustments">Configuration adjustments</a></h3>
<h4 id="correct-severity"><a class="header" href="#correct-severity">Correct Severity</a></h4>
<p>According to <a href="https://docs.appsignal.com/logging/platforms/heroku.html">the docs</a>, getting the severity to be anything but ‚ÄúINFO‚Äù is not possible using the heroku drain.</p>
<p>However, there is now a way to send the <code>"severity=XYZ"</code> logfmt information and have that be applied correctly in appsignal. Unfortunately, just setting this seems to break the recognition of <code>request_id</code> in the format <code>[1234-5678]</code>. So we have to override the <code>ActiveSupport::TaggedLogging::Formatter</code> to add both the <code>severity</code> and the <code>request_id</code> in logfmt syntax.</p>
<pre><code class="language-ruby"># frozen_string_literal: true

if Rails.env.production?
  module ActiveSupport
    module TaggedLogging
      module Formatter
        def call(severity, timestamp, progname, msg)
          logfmt_msg = ["severity=#{severity}", tags_text, msg].compact.join(' ')
          super(severity, timestamp, progname, logfmt_msg)
        end

        def tags_text
          current_tags.map do |tag|
            if tag.is_a? Hash
              tag.map { |k, v| "#{k}=#{v}" }
            else
              "[#{tag}]"
            end
          end.flatten.join(' ')
        end
      end
    end
  end
end
</code></pre>
<p>and</p>
<pre><code class="language-ruby"># config/environments/production.rb
Rails.application.configure do
  # We use our custom key value tagging
  config.log_tags = [-&gt;(request) { { request_id: request.request_id } }]
  logger           = ActiveSupport::Logger.new(STDOUT)
  config.logger    = ActiveSupport::TaggedLogging.new(logger)
end
</code></pre>
<h3 id="lograge"><a class="header" href="#lograge">Lograge</a></h3>
<p>We use <a href="https://github.com/roidrage/lograge">lograge</a> in many projects. Here is how to configure
it with AppSignal to get properly tagged logs.</p>
<p>Using this configuration we get the fully tagged lograge lines and also
the full stack trace with each line tagged with the request id. This allows
us to filter by request id with one click and get all relevant log data at once.</p>
<p><em>With AppSignal gem</em></p>
<pre><code class="language-ruby"># config/initializers/lograge.rb
if ENV['LOGRAGE_ENABLED'] == 'true'
  Rails.application.configure do
    config.lograge.enabled = true
    config.lograge.keep_original_rails_log = true
    config.lograge.logger = Appsignal::Logger.new(
      "rails",
      format: Appsignal::Logger::LOGFMT
    )
    config.lograge.custom_payload do |controller|
      {
        request_id: controller.request.request_id
      }
    end
  end
end
</code></pre>
<p><em>Without AppSignal gem</em></p>
<pre><code class="language-ruby"># config/environments/production.rb
Rails.application.configure do
  ‚Ä¶

  if ENV['RAILS_LOG_TO_STDOUT'].present?
    config.log_tags = [-&gt;(request) { { request_id: request.request_id } }]
    logger          = ActiveSupport::Logger.new($stdout)
    config.logger   = ActiveSupport::TaggedLogging.new(logger)
  end
end
</code></pre>
<pre><code class="language-ruby"># config/initializers/lograge.rb
Rails.application.configure do
  ‚Ä¶

  if ENV['LOGRAGE_ENABLED'] == 'true'
    config.lograge.enabled = true
    config.lograge.keep_original_rails_log = true
  end
end
</code></pre>
<h3 id="automation"><a class="header" href="#automation">Automation</a></h3>
<p>Unfortunately Appsignal doesn‚Äôt provide an API for project configuration.
So if you need to do something on a lot of projects, you have to do it manually.</p>
<p>Project creation can be automated though with the following script.
Run it in a tmp folder. <strong>It writes into a file on disk.</strong></p>
<pre><code class="language-rb">#!/usr/bin/env ruby
require 'optparse'
require 'appsignal'
require 'appsignal/demo'

PUSH_API_KEY = "XXX"

options = {}
OptionParser.new do |opt|
  opt.on('--env APPSIGNAL_ENV') { |o| options[:env] = o }
  opt.on('--name APPSIGNAL_NAME') { |o| options[:name] = o }
end.parse!

raise OptionParser::MissingArgument if options[:env].nil? || options[:name].nil?

File.write 'config/initializers/appsignal.rb', &lt;&lt;~RUBY
  if defined?(Appsignal)
    Appsignal.configure do |config|
      %w[HTTP_REFERER HTTP_USER_AGENT HTTP_AUTHORIZATION REQUEST_URI].each do |header|
        config.request_headers &lt;&lt; header
      end
    end
  end
RUBY

Appsignal.config = Appsignal::Config.new(Dir.pwd, options[:env])
Appsignal::Demo.transmit
</code></pre>
<h2 id="frontend"><a class="header" href="#frontend">Frontend</a></h2>
<p>While the backend uses a secret <code>PUSH_API_KEY</code> to authenticate with AppSignal, the frontend uses a public <code>FRONTEND_API_KEY</code>
to authenticate with AppSignal. This key can only be read once the project is created on AppSignal.
So once the project is created, the frontend API key can be found in the ‚ÄúPush and deploy‚Äù section of your project settings.</p>
<p>Checkout the <a href="https://docs.appsignal.com/front-end/installation.html">AppSignal documentation</a> if you need more information.</p>
<p><em>Installation steps:</em></p>
<ul>
<li>Add the new frontend API key to your Heroku environments:
<pre><code class="language-yml">APPSIGNAL_FRONTEND_API_KEY: "from appsignal"
</code></pre>
</li>
<li>Install the package: <code>yarn add @appsignal/javascript</code></li>
<li>Include <a href="templates/app/views/shared/_appsignal.html.erb">_appsignal.html</a> in your header.</li>
</ul>
<pre><code class="language-erb">&lt;%= render 'shared/appsignal' %&gt;
</code></pre>
<ul>
<li>Include <a href="templates/app/javascript/appsignal.js">appsignal.js</a> in your JS assets.</li>
</ul>
<h2 id="verify-the-installation-1"><a class="header" href="#verify-the-installation-1">Verify the installation</a></h2>
<h3 id="error-monitoring"><a class="header" href="#error-monitoring">Error monitoring</a></h3>
<h4 id="ruby-1"><a class="header" href="#ruby-1">Ruby</a></h4>
<p>For each environment of your app, connect to the <code>heroku run rails console --app [project-name]-[branch-name]</code> and raise an exception using Appsignal:</p>
<pre><code>begin
  1 / 0
rescue ZeroDivisionError =&gt; exception
  Appsignal.send_error(exception)
end
</code></pre>
<p>You should find the exception of the ZeroDivisionError on Appsignal after a minute or two.</p>
<h4 id="javascript-1"><a class="header" href="#javascript-1">Javascript</a></h4>
<p>Open the dev console in chrome, and run</p>
<pre><code class="language-js">try {
  throw new Error('test appsignal js');
} catch(e) {
  Appsignal.sendError(e)
}
</code></pre>
<p>On Appsignal you should find ‚ÄúUncaught Error: test appsignal js‚Äù.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="-hotjar"><a class="header" href="#-hotjar">üî• Hotjar</a></h1>
<ul>
<li>
<p>Add a new site on the Hotjar dashboard using the Renuo Hotjar account
(credentials are in Passwork). Note the site ID of the generated site.</p>
</li>
<li>
<p>Add the following gem to your Gemfile:</p>
</li>
</ul>
<pre><code class="language-ruby">group :production do
  gem 'rack-tracker'
end
</code></pre>
<ul>
<li>Configure the tracker in <code>production.rb</code>:</li>
</ul>
<pre><code class="language-ruby">if ENV['HOTJAR_SITE_ID'].present?
    config.middleware.use(Rack::Tracker) do
      handler :hotjar, site_id: ENV['HOTJAR_SITE_ID']
    end
end
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="wicked-pdf"><a class="header" href="#wicked-pdf">Wicked PDF</a></h1>
<p>Can be used to generate PDFs and supports HTML to PDF.</p>
<p>‚ö† Up to now, Wicked PDF does not support Bootstrap 4, so if you want to use Bootstrap 4 Templates, use another library ‚ö†</p>
<ul>
<li>Add <code>gem 'wicked_pdf'</code> to the main section of <code>Gemfile</code></li>
<li>Add <code>gem 'wkhtmltopdf-binary'</code> to <code>group :development, :test</code></li>
<li>Add <code>gem 'wkhtmltopdf-heroku'</code> to <code>group :production</code></li>
</ul>
<p>By default, it adds no layout, you you may want to add a layout:</p>
<ul>
<li>Create a <code>pdf.pdf.erb</code></li>
<li>Use the method to add stylesheets : <code>wicked_pdf_stylesheet_link_tag 'pdf', media: 'all'</code></li>
<li>Use the method <code>wicked_pdf_image_tag</code> to insert images to the layout.</li>
</ul>
<p><em>Usage:</em></p>
<pre><code class="language-rb">render pdf: &lt;&lt;filename&gt;&gt;, print_media_type: true, layout: 'pdf', disposition: 'attachment'
</code></pre>
<p>‚ö† Consider using a job-runner to not block the server during creation of PDFs.</p>
<h2 id="heroku-3"><a class="header" href="#heroku-3">Heroku</a></h2>
<p>Ensure that fonts are installed on Heroku, otherwise the PDF will look different compared to the one generated locally. The fonts need to be installed with a buildpack and put in the <code>~/.fonts</code> folder.
If you need Arial, you can add the following buildpack on Heroku:</p>
<p><code>https://github.com/propertybase/heroku-buildpack-fonts</code></p>
<p>‚ö† Make sure you add this as a first buildpack before <code>heroku/ruby</code>!</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="recaptcha-v3"><a class="header" href="#recaptcha-v3">reCAPTCHA v3</a></h1>
<p>Here you will learn how to implement reCAPTCHA v3 into a project. It is pretty simple to use and doesn‚Äôt
hinder the users at all, as it all runs in the background.</p>
<h2 id="implementation"><a class="header" href="#implementation">Implementation</a></h2>
<p>Before you start, consider checking which page you would like to protect against suspicious activity (like spambots).</p>
<h3 id="site-registration"><a class="header" href="#site-registration">Site registration</a></h3>
<p>After you‚Äôve decided, you can go to the <a href="https://www.google.com/recaptcha/admin">reCAPTCHA admin panel</a> and register
a new site. Make sure you‚Äôre using the Renuo admin account.</p>
<p>To register the site, you can follow these steps:</p>
<ol>
<li>Use <code>[project-name]</code> as a label for the site.</li>
<li>Choose reCAPTCHA v3</li>
<li>Add all the domains on which reCAPTCHA should work (<code>renuoapp.ch</code> should also be included for the <code>develop</code> environment)</li>
</ol>
<p>After you‚Äôve provided all the necessary data, you will be forwarded to a page where you will find the <code>site</code> and
<code>secret</code> keys. These will be needed later on (you can always find them in the site settings).</p>
<h3 id="frontend-implementation"><a class="header" href="#frontend-implementation">Frontend implementation</a></h3>
<p>For the frontend implementation, you can follow <a href="https://developers.google.com/recaptcha/docs/v3">these steps</a>
and integrate reCAPTCHA into the chosen view.</p>
<h3 id="backend-implementation"><a class="header" href="#backend-implementation">Backend implementation</a></h3>
<p>For the validation to work, you will also need some backend code which will call the reCAPTCHA verification API,
which then returns a score based on which it will be decided if the request (to your site) was normal or suspicious. You can follow <a href="https://developers.google.com/recaptcha/docs/verify">these steps</a> to do it.</p>
<p>If you have trouble integrating reCAPTCHA, you can find some inspiration by checking out one of these pull requests:</p>
<ol>
<li><a href="https://github.com/renuo/kingschair2/pull/182">Kingschair</a></li>
<li><a href="https://github.com/renuo/germann/pull/314">Germann</a></li>
</ol>
<h2 id="testing"><a class="header" href="#testing">Testing</a></h2>
<p>In order to test it, you can add <code>localhost</code> as a domain in the
<a href="https://www.google.com/recaptcha/admin">reCAPTCHA admin panel</a> and provide the required keys in
the <code>.env</code>. If your integration worked, then you will see a small container in the bottom right
corner of your chosen page, something like this:
<img src="https://user-images.githubusercontent.com/31915276/55479133-ae4f8c80-561d-11e9-9df2-d94cbc5f92d3.png" alt="reCAPTCHA demonstration"></p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="google-analytics"><a class="header" href="#google-analytics">Google Analytics</a></h1>
<p>Google Analytics is only set up for the main branch (since *.renuoapp.ch domains are tracked via Cloudflare injection).</p>
<p>To add a new project to the GA account go to <a href="https://www.google.com/analytics">https://www.google.com/analytics</a> and login as google@renuo.ch.</p>
<ol>
<li>Go to the tab ‚ÄòVerwalten‚Äô under settings and you will see a dropdown on the left with all the project</li>
<li>Chose the option above that says ‚ÄòCreate Account‚Äô</li>
<li>Fill out the Data based on your project.</li>
<li>In Property Management, under Data Steam, choose th platform you‚Äôd like to create the tracking for. Make sure ‚ÄòEnhanced Measurement‚Äô is enabled.</li>
<li>Once you saved, you will see the tracking snippet. Note: You can always find it again later under Porperty/Data Streams.</li>
<li>Write down the Measurement ID (the string in the snippet with all caps and starting with an G-XXX‚Ä¶.) and note it - you will need it for the Heroku config.</li>
</ol>
<p>Choose one of the given options to set up Google Analytics:</p>
<h2 id="a-javascript-only-gtag-script-recommended"><a class="header" href="#a-javascript-only-gtag-script-recommended">a) Javascript only: gtag script (recommended)</a></h2>
<p>This way is recommended in the normal case, because it doesn‚Äôt involve another gem dependency. Since Google proposes the
Tag Manager as a default, the Analytics Script is a bit hidden. Tag Manager makes sites slower, therefor one has to decide on a case-by-case basis whether the advantages of a tag manager outweigh the disadvantages. In each case use only the gtag
script which you can find <a href="https://developers.google.com/analytics/devguides/collection/gtagjs#install_the_global_site_tag">here</a></p>
<pre><code class="language-html">&lt;!-- Google tag (gtag.js) --&gt;
&lt;script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"&gt;&lt;/script&gt;
&lt;script&gt;
  window.dataLayer = window.dataLayer || [];
  function gtag(){window.dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XXXXXXXXXX');
&lt;/script&gt;
</code></pre>
<p>Make sure you insert this script at the end of the <code>&lt;head&gt;</code> tag of the page (not in the <code>&lt;body&gt;</code>).</p>
<p>NOTE: There is a default IP anonymization feature in GA4. We no longer need to perform this step manually.</p>
<h2 id="b-ruby-rack-tracker"><a class="header" href="#b-ruby-rack-tracker">b) Ruby rack-tracker</a></h2>
<p>There‚Äôs a gem which can be used for a lot of trackers: <a href="https://github.com/railslove/rack-tracker#installation">https://github.com/railslove/rack-tracker#installation</a></p>
<pre><code class="language-rb">group :production do
  ...
  gem 'rack-tracker'
end
</code></pre>
<p>and write to <code>config/environments/production.rb</code></p>
<pre><code class="language-ruby">config.middleware.use(Rack::Tracker) do
  if ENV['GOOGLE_ANALYTICS_ID'].present?
    handler :google_analytics, tracker: ENV['GOOGLE_ANALYTICS_ID'], anonymize_ip: true, advertising: true
  end
end
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="google-apis"><a class="header" href="#google-apis">Google APIs</a></h1>
<ul>
<li>
<p>If you need Google APIs in your project (e. g. Google Maps) proceed to the <a href="https://console.cloud.google.com">Google Cloud Console</a>
using the google@renuo.ch account.</p>
</li>
<li>
<p>Create a project named <code>[project-name]</code> under the renuo.ch organisation and use that project for all your environments.</p>
</li>
<li>
<p>Attach the <em>wg-operations</em> billing account</p>
</li>
<li>
<p>Choose the correct resource folder</p>
<ul>
<li><code>clients</code> for client projects</li>
<li><code>wg-operations</code> for persistent internal things (e.g. Renuo Dashboard)</li>
<li><code>tmp</code> for trials (e.g. learning week, presentations)</li>
<li><code>system-gsuite</code> is for Google app script</li>
</ul>
<p><img src="images/google_app_1.png" alt="google_app_1"></p>
</li>
</ul>
<p>Before continuing, make sure that your new project is selected in the top navigational header of the Google Console.</p>
<h2 id="maps-javascript-api"><a class="header" href="#maps-javascript-api">Maps JavaScript API</a></h2>
<p><strong>API key generation</strong></p>
<p>In order to user the Google APIs you will need to generate new credentials. Because we are using only one project per application, but would like to separate the usage in development from the one in production, name the keys like so: <code>maps-main</code> and <code>maps-develop</code>. Because we might need a key to also test the map locally, add a separate one named <code>maps-local</code>.</p>
<p><strong>API key restrictions</strong></p>
<p>To prevent quota and key theft, we need to add some restrictions to our keys. There are two types of restrictions: Key restrictions and API restrictions. For the develop API key add the following ones:</p>
<p><img src="images/google_app_2.png" alt="google_app_2"></p>
<p>For main, enable only the specific domain <strong>and</strong> the <code>renuoapp.ch</code> domain.</p>
<p>For the key we use locally, enable the specific localhost domain (<code>project-name.localhost</code>).</p>
<h2 id="geocoding-api"><a class="header" href="#geocoding-api">Geocoding API</a></h2>
<p><strong>API key generation</strong></p>
<p>As for the JS API, create two different keys for the two environments. For this API, name the keys like this: <code>geocoding-main</code> and <code>geocoding-develop</code>.</p>
<p><strong>API key restrictions</strong></p>
<p>Because the Geocoding API key doesn‚Äôt support HTTP referrer restrictions (which isn‚Äôt a problem anyway since the key won‚Äôt be exposed), you only need to add an API restriction, restricting the key to the Geocoding API.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="slack-and-notifications"><a class="header" href="#slack-and-notifications">Slack and Notifications</a></h1>
<p>If you want to keep your team up-to-date with some notifications about the project and to discuss project-related topics
we suggest you to use <a href="https://renuo.slack.com/">Slack</a>.</p>
<p>You are, for sure, already a member of slack.</p>
<h2 id="project-channel"><a class="header" href="#project-channel">Project Channel</a></h2>
<p>You can create a project-dedicated channel on slack naming it <code>#project-[project-name]</code> (e.g. <code>#project-bookshelf</code>,
<code>#project-gifcoins</code>, etc..).</p>
<p>Invite all team members involved in the project to the channel.</p>
<h2 id="deploy-notifications"><a class="header" href="#deploy-notifications">Deploy Notifications</a></h2>
<p>One notification you may want to receive on this channel is about when a new deployment on main has been performed. In
order to do that you must be an admin of the Renuo Slack Organisation. If you are not an admin, ask wg-operations to do
it for you communicating the <code>[project-name]</code>.</p>
<p>‚ö† <strong>You must have already setup <a href="#configure-the-ci">Automatic Deployment through SemaphoreCI</a></strong> ‚ö†
If you used Renuo CLI to configure SemaphoreCI, the notifications should be already created. For manual setup, follow these steps:</p>
<ol>
<li>Open the project Notifications settings (<code>https://renuo.semaphoreci.com/notifications</code>)</li>
<li>Create New Notification</li>
<li>Name of the Notification -&gt; <code>[project-name]</code></li>
<li>Name of the Rule -&gt; <code>Slack notifications</code></li>
<li>Branches -&gt; <code>main</code></li>
<li>Slack Endpoint: Use the Webhook URL from other projects</li>
<li>Send to Slack channel: <code>#project-[project-name]</code></li>
<li>Save changes</li>
</ol>
<blockquote>
<p>We do not want to pollute the channel with many notifications, therefore we suggest to only send a notification about
deployments to production.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="project-title"><a class="header" href="#project-title">Project Title</a></h1>
<p>Short project description</p>
<h2 id="environments"><a class="header" href="#environments">Environments</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Branch</th><th>Domain</th><th>Deployment</th></tr>
</thead>
<tbody>
<tr><td>develop</td><td>https://<code>[project-name]</code>-develop.renuoapp.ch</td><td>auto</td></tr>
<tr><td>main</td><td>https://<code>[project-name]</code>-main.renuoapp.ch</td><td>release</td></tr>
</tbody>
</table>
</div>
<h2 id="setup-2"><a class="header" href="#setup-2">Setup</a></h2>
<pre><code class="language-sh">git clone git@github.com:renuo/[project-name].git
cd [project-name]
bin/setup
</code></pre>
<h3 id="configuration-2"><a class="header" href="#configuration-2">Configuration</a></h3>
<p>Configure the following:</p>
<ul>
<li>.env</li>
</ul>
<h3 id="run"><a class="header" href="#run">Run</a></h3>
<pre><code class="language-sh">bin/run
</code></pre>
<h3 id="dependency"><a class="header" href="#dependency">Dependency</a></h3>
<p>Dependencies list</p>
<h3 id="tests--checks"><a class="header" href="#tests--checks">Tests / Checks</a></h3>
<pre><code class="language-sh">bin/check
</code></pre>
<h2 id="other-1"><a class="header" href="#other-1">Other</a></h2>
<p>special stuff</p>
<h2 id="copyright"><a class="header" href="#copyright">Copyright</a></h2>
<p>Copyright <a href="https://www.renuo.ch/">Renuo AG</a>.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="pull-requests-template"><a class="header" href="#pull-requests-template">Pull Requests Template</a></h1>
<p>You should probably configure a template for the Pull Requests in your project.</p>
<p>This template will give a list of reminders and important points that the developer
needs to remember when opening a new Pull Request.</p>
<p>We think this template is useful as a checklist of things that shouldn‚Äôt be forgotten
when assigning a Pull Request to one of your colleagues.</p>
<p>Feel free to personalise the template for your project specific needs.
If you think your changes would be useful also in other projects,
please open a Pull Request to update this template.</p>
<p>To install the template copy this file into a <code>.github</code> folder in your project or
simply run the following command from the root folder of the project:</p>
<pre><code class="language-bash">mkdir -p .github &amp;&amp; curl https://raw.githubusercontent.com/renuo/application-setup-guide/main/templates/PULL_REQUEST_TEMPLATE.md &gt; .github/PULL_REQUEST_TEMPLATE.md
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
