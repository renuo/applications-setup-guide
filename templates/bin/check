#!/bin/sh

if ! grep --exclude-dir="app/assets/typings/**" -i -r 'console.log' app spec
then
  echo 'console.log found. Please fix them and try again, commit aborted'
  exit 1
fi

if ! bundle exec mdl ./
then
  echo 'Violated markdown rules, see https://github.com/mivok/markdownlint/blob/master/docs/RULES.md, commit aborted'
  exit 1
fi

if ! bundle exec rubocop -D -c .rubocop.yml --fail-fast
then
  echo 'rubocop detected issues!'
  bundle exec rubocop -a -D -c .rubocop.yml
  echo 'Tried to auto correct the issues, but must be reviewed manually, commit aborted'
  exit 1
fi

if ! bundle exec slim-lint app/views/ -c .slim-lint.yml
then
  echo 'slim-lint detected issues, commit aborted'
  exit 1
fi

DIFF_BEFORE=`git diff | shasum -a 256`
csscomb -v src/app/**/*.scss
DIFF_AFTER=`git diff | shasum -a 256`
if [ $DIFF_BEFORE -ne $DIFF_AFTER ]; then
  echo 'csscomb has rearranged some of your css that has to be reviewed manually, commit aborted'
  exit 1
fi

if ! scss-lint app/assets/stylesheets/**/*.scss
then
  echo 'scss-lint detected issues, commit aborted'
  exit 1
fi

# for typescript

if ! tslint -c tslint.json app/assets/javascripts/**/*.ts
then
  echo 'tslint detected issues, commit aborted'
  exit 1
fi

# for coffeescript

if ! coffeelint -f .coffeelint.json app/assets/javascripts/**/*.coffee
then
  echo 'coffeelint detected issues, commit aborted!'
  exit 1
fi

if ! bundle exec brakeman -q -z --summary > /dev/null
then
  echo 'Brakeman has detected one or more security vulnerabilities, please review them and re-commit your changes, commit aborted'
  exit 1
fi

if ! bundle exec reek
then
  echo 'reek detected code smells, commit aborted'
  exit 1
fi

if ! bundle exec rspec
then
  echo 'rspec did not run successfully, commit aborted'
  exit 1
fi

